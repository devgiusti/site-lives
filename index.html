<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
  <title>MultiVPlayers - Gemini Ultra</title>
  <style>
    /* --- VariÃ¡veis CSS para o Tema DinÃ¢mico --- */
    :root {
      --bg-color: #050505;
      --card-bg: #000000;
      --sidebar-bg: #111111;
      --text-color: #e0e0e0;
      --accent-color: #9146ff;
      --border-color: #333333;
      --header-height: 60px;
    }

    /* --- Estilos Gerais --- */
    body {
      margin: 0;
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.5s ease, color 0.5s ease;
    }

    /* --- Barra Superior (Header) --- */
    .app-top-bar {
        height: var(--header-height);
        background-color: var(--sidebar-bg);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        z-index: 100;
        flex-shrink: 0;
    }

    .app-logo {
        font-weight: 800;
        font-size: 1.2rem;
        background: linear-gradient(90deg, #4285f4, #9b72cb);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-right: 20px;
    }

    /* TÃ­tulo da SessÃ£o */
    #sessionTitleHeader {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-color);
        opacity: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex-grow: 1;
        text-align: center;
        margin: 0 20px;
        transition: opacity 0.5s ease;
    }
    #sessionTitleHeader.visible { opacity: 1; }

    /* Container de BotÃµes do Header */
    .header-actions {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* Seletor de Idioma */
    .lang-select {
        background-color: rgba(255,255,255,0.05);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        height: 36px;
        padding: 0 10px;
        cursor: pointer;
        font-size: 13px;
        outline: none;
        margin-right: 5px;
    }
    .lang-select:hover { background-color: rgba(255,255,255,0.1); }
    .lang-select option { background-color: var(--sidebar-bg); }

    /* BotÃµes da Toolbar */
    .toolbar-btn {
        background-color: rgba(255,255,255,0.05);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        height: 36px;
        padding: 0 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s;
    }
    .toolbar-btn:hover { background-color: rgba(255,255,255,0.1); border-color: var(--text-color); }
    
    .btn-primary { background-color: var(--accent-color); color: white; border: none; }
    .btn-primary:hover { filter: brightness(1.1); background-color: var(--accent-color); }
    
    .btn-ai { 
        background: linear-gradient(135deg, rgba(66, 133, 244, 0.2), rgba(155, 114, 203, 0.2)); 
        border-color: #9b72cb; 
        color: #d0bfff;
    }
    .btn-ai:hover { background: linear-gradient(135deg, rgba(66, 133, 244, 0.4), rgba(155, 114, 203, 0.4)); color: white; }


    /* --- Layout Principal --- */
    .main-container {
        display: flex;
        flex: 1;
        overflow: hidden;
        position: relative;
    }

    #fileProtocolWarning {
        display: none;
        background-color: #aa0000;
        color: white;
        padding: 5px;
        text-align: center;
        font-weight: bold;
        font-size: 12px;
    }

    /* --- Ãrea de Mosaico --- */
    .video-area {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-content: center; 
      padding: 10px;
      gap: 10px;
      overflow-y: auto;
      background-color: var(--bg-color);
      transition: background-color 0.5s ease;
      position: relative;
    }

    .video-area::-webkit-scrollbar { width: 8px; }
    .video-area::-webkit-scrollbar-track { background: var(--bg-color); }
    .video-area::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
    .video-area::-webkit-scrollbar-thumb:hover { background: #555; }

    .content-card {
      background-color: var(--card-bg);
      position: relative;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 10px 20px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease; 
    }
    
    .content-card:hover { border-color: var(--accent-color); }

    .iframe-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
      background: #000;
      flex-grow: 1;
      transition: all 0.3s ease;
    }

    .iframe-wrapper iframe, 
    .iframe-wrapper object, 
    .iframe-wrapper embed {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      border: none;
    }

    .card-header-overlay {
        position: absolute;
        top: 0; left: 0; width: 100%;
        height: 40px;
        background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
        z-index: 20;
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 5px;
        box-sizing: border-box;
        pointer-events: none;
    }
    .content-card:hover .card-header-overlay { opacity: 1; }

    .btn-group { display: flex; gap: 5px; pointer-events: auto; }

    .btn-icon {
        background: rgba(20, 20, 20, 0.9);
        color: #fff;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        width: 28px; height: 28px;
        cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        font-size: 14px;
        transition: all 0.2s;
    }
    .btn-icon:hover { background: var(--accent-color); border-color: var(--accent-color); }
    .btn-remove:hover { background: #d32f2f; border-color: #d32f2f; }
    .btn-ai-info { border-color: #4285f4; color: #4285f4; }
    .btn-ai-info:hover { background: #4285f4; color: white; }

    .info-toast {
        position: absolute;
        top: 40px;
        left: 10px; right: 10px;
        background: rgba(10, 10, 10, 0.95);
        border: 1px solid var(--accent-color);
        color: var(--text-color);
        padding: 10px;
        border-radius: 6px;
        font-size: 13px;
        z-index: 30;
        display: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.8);
        pointer-events: auto;
    }
    .info-toast.visible { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }

    /* --- Chat Panel --- */
    .chat-panel {
      width: 360px;
      max-width: 100%;
      background-color: var(--sidebar-bg);
      display: flex;
      flex-direction: column;
      border-left: 1px solid var(--border-color);
      transition: all 0.5s ease;
      z-index: 50;
    }
    
    .chat-panel.hidden { margin-right: -360px; display: flex !important; }

    .chat-header {
      padding: 10px;
      background-color: rgba(255,255,255,0.05);
      border-bottom: 1px solid var(--border-color);
      display: flex; justify-content: space-between; align-items: center;
      gap: 10px;
    }

    .chat-select {
      flex-grow: 1;
      background-color: rgba(0,0,0,0.3);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      padding: 8px;
      border-radius: 4px;
      font-size: 13px;
      outline: none;
    }
    .chat-select:focus { border-color: var(--accent-color); }

    .chat-container { flex-grow: 1; position: relative; background: #000; }
    
    .chat-placeholder {
        display:flex; flex-direction:column; justify-content:center; align-items:center; 
        height:100%; color: var(--text-color); opacity: 0.5; text-align: center; padding: 20px; font-size: 14px;
    }

    /* --- Modais --- */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.9);
      backdrop-filter: blur(4px);
      display: flex; justify-content: center; align-items: center;
      z-index: 999;
      opacity: 0; visibility: hidden;
      transition: opacity 0.2s;
    }
    .modal-overlay.visible { opacity: 1; visibility: visible; }

    .modal-panel {
      background-color: var(--sidebar-bg);
      color: var(--text-color);
      padding: 30px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      box-shadow: 0 20px 50px rgba(0,0,0,0.8);
      width: 90%; max-width: 600px;
      display: flex; flex-direction: column; gap: 15px;
      max-height: 90vh; overflow-y: auto;
      transition: background-color 0.5s ease;
    }

    .modal-panel h2 { margin: 0; font-size: 22px; }
    
    .input-group input {
      padding: 15px;
      background-color: rgba(0,0,0,0.2);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      border-radius: 6px;
      font-size: 16px;
      outline: none;
      width: 100%; box-sizing: border-box;
    }
    .input-group input:focus { border-color: var(--accent-color); }

    .primary-btn {
      padding: 15px;
      background-color: var(--accent-color);
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
      text-transform: uppercase; letter-spacing: 0.5px;
      transition: background-color 0.3s;
    }
    .primary-btn:hover { filter: brightness(1.2); }
    .primary-btn:disabled { background-color: #555; cursor: not-allowed; }

    /* --- AI Panel Specifics --- */
    .ai-tabs {
        display: flex; gap: 10px; margin-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
        overflow-x: auto;
    }
    .ai-tab {
        background: transparent; border: none;
        color: var(--text-color); opacity: 0.6;
        cursor: pointer; padding: 8px 16px;
        font-weight: bold; border-radius: 4px;
        transition: 0.2s;
        white-space: nowrap;
    }
    .ai-tab.active { background: rgba(155, 114, 203, 0.2); opacity: 1; color: var(--accent-color); }
    .ai-tab:hover { opacity: 1; }

    .ai-content { display: none; }
    .ai-content.active { display: block; }

    .gemini-chat-box {
        background: rgba(0,0,0,0.2);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        height: 300px;
        overflow-y: auto;
        padding: 15px;
        margin-bottom: 10px;
        display: flex; flex-direction: column; gap: 10px;
    }
    .chat-msg {
        padding: 8px 12px; border-radius: 8px;
        max-width: 80%; line-height: 1.4; font-size: 14px;
    }
    .chat-msg.user { background: var(--border-color); align-self: flex-end; color: var(--text-color); }
    .chat-msg.ai {
        background: rgba(66, 133, 244, 0.15);
        align-self: flex-start; color: var(--text-color);
        border: 1px solid rgba(66, 133, 244, 0.3);
    }
    .loading-dots:after { content: ' .'; animation: dots 1s steps(5, end) infinite; }
    @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 80%, 100% { content: ''; } }

  </style>
</head>
<body>

  <!-- Aviso de Erro CrÃ­tico -->
  <div id="fileProtocolWarning" data-i18n="error_protocol">
      âš ï¸ ERRO: VocÃª abriu este arquivo diretamente do PC. Use um servidor local (Live Server) para a Twitch funcionar.
  </div>

  <!-- Barra Superior (Header) -->
  <header class="app-top-bar">
      <div class="app-logo">MultiVPlayers</div>
      
      <div id="sessionTitleHeader"></div>

      <div class="header-actions">
          <!-- Seletor de Idioma -->
          <select id="langSelect" class="lang-select">
              <option value="pt">ğŸ‡§ğŸ‡· PT</option>
              <option value="en">ğŸ‡ºğŸ‡¸ EN</option>
              <option value="es">ğŸ‡ªğŸ‡¸ ES</option>
              <option value="fr">ğŸ‡«ğŸ‡· FR</option>
              <option value="de">ğŸ‡©ğŸ‡ª DE</option>
              <option value="it">ğŸ‡®ğŸ‡¹ IT</option>
              <option value="ru">ğŸ‡·ğŸ‡º RU</option>
              <option value="zh">ğŸ‡¨ğŸ‡³ CN</option>
              <option value="ja">ğŸ‡¯ğŸ‡µ JP</option>
          </select>

          <button class="toolbar-btn btn-ai" id="aiFab" title="IA Tools">
              <span data-i18n="header_ai">âœ¨ IA Tools</span>
          </button>
          
          <button class="toolbar-btn btn-primary" id="fab" title="Adicionar">
              <span data-i18n="header_add">+ Adicionar</span>
          </button>
          
          <button class="toolbar-btn" id="toggleChatFab" title="Chat">
              <span data-i18n="header_chat">ğŸ’¬ Chat</span>
          </button>
      </div>
  </header>

  <!-- Container Principal -->
  <div class="main-container">
      
      <!-- Ãrea de Mosaico -->
      <div class="video-area" id="contentGrid">
          <!-- Cards serÃ£o injetados aqui -->
      </div>

      <!-- Painel Lateral de Chat -->
      <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
          <strong data-i18n="chat_title">Chats</strong>
          <button onclick="toggleChat()" data-i18n="chat_hide" title="Ocultar" style="background:none; border:none; color:var(--text-color); cursor:pointer;">&#10005;</button>
        </div>
        
        <div style="padding: 10px; display:flex; gap:5px;">
            <select id="chatSelect" class="chat-select" onchange="changeChat()">
                <option value="" disabled selected data-i18n="chat_select_default">Selecione um canal...</option>
            </select>
            <button onclick="resetChat()" title="Limpar" style="background:rgba(255,255,255,0.05); border:1px solid var(--border-color); color:var(--text-color); border-radius:4px; width:35px; cursor:pointer; display:flex; align-items:center; justify-content:center;">
                 &#10005;
            </button>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="chat-placeholder">
                <p data-i18n="chat_placeholder">Selecione um canal acima para carregar o chat.</p>
            </div>
        </div>
      </div>

  </div>

  <!-- Modal de Input Manual -->
  <div class="modal-overlay" id="urlInputOverlay">
    <div class="modal-panel url-input-panel">
      <h2 data-i18n="modal_add_title">Adicionar ConteÃºdo</h2>
      <p style="opacity:0.7; font-size:14px; margin-top:-10px;" data-i18n="modal_add_desc">Cole URL ou cÃ³digo HTML (iframe/embed).</p>
      
      <div class="input-group">
        <input type="text" id="urlInput" placeholder="https://... ou <iframe...>" autocomplete="off">
      </div>
      
      <button class="primary-btn" id="addUrlButton" data-i18n="modal_add_btn">Adicionar ao Mosaico</button>
      
      <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; font-size: 12px; opacity: 0.7;">
          <strong data-i18n="modal_add_tip">Dica: Se um site nÃ£o carregar (tela branca), use o botÃ£o de seta â†— no cartÃ£o para abrir externamente.</strong>
      </div>
    </div>
  </div>

  <!-- Modal IA (Gemini) -->
  <div class="modal-overlay" id="aiOverlay">
    <div class="modal-panel">
      <div style="display:flex; justify-content:space-between; align-items:center;">
          <h2 style="background: linear-gradient(90deg, #4285f4, #d96570); -webkit-background-clip: text; -webkit-text-fill-color: transparent;" data-i18n="ai_title">MultiVPlayers AI âœ¨</h2>
          <button id="closeAiBtn" style="background:none; border:none; color:var(--text-color); cursor:pointer; font-size:20px;">&times;</button>
      </div>
      
      <!-- API Key Section -->
      <div id="apiKeySection" style="background:rgba(0,0,0,0.3); padding:10px; border-radius:6px; font-size:13px; margin-bottom:10px;">
          <div style="display:flex; gap:10px; align-items:center;">
              <span style="opacity:0.7;" data-i18n="ai_key_label">Gemini API Key:</span>
              <input type="password" id="apiKeyInput" placeholder="..." style="background:rgba(0,0,0,0.5); border:1px solid var(--border-color); color:white; padding:5px; border-radius:4px; flex-grow:1;">
              <button id="saveKeyBtn" style="background:var(--border-color); color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;" data-i18n="ai_save_btn">Salvar</button>
          </div>
          <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:#4285f4; font-size:11px; text-decoration:none; margin-top:5px; display:inline-block;" data-i18n="ai_get_key">Obter Chave GrÃ¡tis</a>
      </div>

      <div class="ai-tabs">
          <button class="ai-tab active" onclick="switchTab('mosaic')" data-i18n="tab_mosaic">Mosaico MÃ¡gico</button>
          <button class="ai-tab" onclick="switchTab('session')" data-i18n="tab_session">ğŸ§  SessÃ£o</button>
          <button class="ai-tab" onclick="switchTab('theme')" data-i18n="tab_theme">ğŸ¨ Temas</button>
          <button class="ai-tab" onclick="switchTab('copilot')" data-i18n="tab_copilot">Co-Piloto</button>
      </div>

      <!-- Tab 1: Mosaico MÃ¡gico -->
      <div id="tab-mosaic" class="ai-content active">
          <p style="opacity:0.8; font-size:14px;" data-i18n="mosaic_desc">A IA pesquisa vÃ­deos reais na internet e monta o layout para vocÃª.</p>
          <div class="input-group">
            <input type="text" id="aiMosaicPrompt" placeholder="..." autocomplete="off">
          </div>
          <button class="primary-btn" id="generateMosaicBtn" style="margin-top:15px; width:100%;" data-i18n="mosaic_btn">âœ¨ Gerar Mosaico</button>
          <div id="mosaicStatus" style="margin-top:10px; font-size:13px; opacity:0.7; font-style:italic;"></div>
      </div>

      <!-- Tab 2: Gerenciador de SessÃ£o -->
      <div id="tab-session" class="ai-content">
          <p style="opacity:0.8; font-size:14px;" data-i18n="session_desc">A IA analisa seus vÃ­deos abertos para organizar sua experiÃªncia.</p>
          
          <div style="display:grid; gap:10px; margin-top:15px;">
              <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px;">
                  <strong style="display:block; margin-bottom:5px;" data-i18n="session_name_title">ğŸ·ï¸ Nomear SessÃ£o</strong>
                  <p style="font-size:12px; opacity:0.6; margin-bottom:10px;" data-i18n="session_name_desc">Cria um tÃ­tulo Ã©pico baseado no que vocÃª estÃ¡ assistindo.</p>
                  <button class="primary-btn" id="aiSessionNameBtn" style="width:100%; font-size:14px; padding:10px;" data-i18n="session_name_btn">Gerar TÃ­tulo</button>
              </div>
              
              <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px;">
                  <strong style="display:block; margin-bottom:5px;" data-i18n="session_expand_title">â• Expandir SessÃ£o</strong>
                  <p style="font-size:12px; opacity:0.6; margin-bottom:10px;" data-i18n="session_expand_desc">A IA busca e adiciona 2 vÃ­deos que combinam com o que jÃ¡ estÃ¡ na tela.</p>
                  <button class="primary-btn" id="aiExpandSessionBtn" style="width:100%; font-size:14px; padding:10px; background-color: #4285f4;" data-i18n="session_expand_btn">Expandir Magic (+2)</button>
              </div>

              <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px;">
                  <strong style="display:block; margin-bottom:5px;" data-i18n="session_bgm_title">ğŸµ DJ de Ambiente (BGM)</strong>
                  <p style="font-size:12px; opacity:0.6; margin-bottom:10px;" data-i18n="session_bgm_desc">Adiciona uma mÃºsica de fundo do YouTube que combina com os vÃ­deos.</p>
                  <button class="primary-btn" id="aiAmbienceBtn" style="width:100%; font-size:14px; padding:10px; background-color: #d96570;" data-i18n="session_bgm_btn">Sugerir & Adicionar</button>
              </div>
          </div>
          <div id="sessionStatus" style="margin-top:10px; font-size:13px; opacity:0.7; text-align:center;"></div>
      </div>

      <!-- Tab 3: Gerador de Temas -->
      <div id="tab-theme" class="ai-content">
          <p style="opacity:0.8; font-size:14px;" data-i18n="theme_desc">Descreva uma atmosfera e a IA mudarÃ¡ as cores do site.</p>
          <div class="input-group">
            <input type="text" id="aiThemePrompt" placeholder="..." autocomplete="off">
          </div>
          <button class="primary-btn" id="generateThemeBtn" style="margin-top:15px; width:100%;" data-i18n="theme_btn">ğŸ¨ Aplicar Tema</button>
          <button onclick="resetTheme()" style="margin-top:10px; background:transparent; border:1px solid var(--border-color); color:var(--text-color); padding:8px; width:100%; border-radius:6px; cursor:pointer;" data-i18n="theme_reset">Resetar PadrÃ£o</button>
      </div>

      <!-- Tab 4: Co-Piloto -->
      <div id="tab-copilot" class="ai-content">
          <div class="gemini-chat-box" id="aiChatBox">
              <div class="chat-msg ai" data-i18n="copilot_msg">OlÃ¡! Sou seu assistente. Pergunte sobre jogos, estratÃ©gias ou qualquer coisa!</div>
          </div>
          <div style="display:flex; gap:10px;">
              <input type="text" id="aiChatInput" placeholder="..." style="flex-grow:1; padding:10px; border-radius:6px; border:1px solid var(--border-color); background:rgba(0,0,0,0.2); color:var(--text-color);">
              <button id="aiChatSend" style="padding:0 15px; background:var(--accent-color); color:white; border:none; border-radius:6px; cursor:pointer;">â¤</button>
          </div>
      </div>

    </div>
  </div>

  <script>
    // --- ConfiguraÃ§Ãµes e Estado ---
    const LS_KEY = 'multiVPlayers_final_data';
    const API_KEY_LS = 'gemini_api_key';
    const LANG_KEY = 'multiVPlayers_lang';
    let twitchChannels = [];
    let currentHostname = window.location.hostname;
    const systemApiKey = ""; 
    let currentLang = localStorage.getItem(LANG_KEY) || 'pt';

    // --- TraduÃ§Ãµes ---
    const translations = {
        pt: {
            error_protocol: "âš ï¸ ERRO: VocÃª abriu este arquivo diretamente do PC. Use um servidor local (Live Server) para a Twitch funcionar.",
            header_ai: "âœ¨ IA Tools",
            header_add: "+ Adicionar",
            header_chat: "ğŸ’¬ Chat",
            chat_title: "Chats",
            chat_hide: "Ocultar",
            chat_select_default: "Selecione um canal...",
            chat_placeholder: "Selecione um canal acima para carregar o chat.",
            modal_add_title: "Adicionar ConteÃºdo",
            modal_add_desc: "Cole URL ou cÃ³digo HTML (iframe/embed).",
            modal_add_btn: "Adicionar ao Mosaico",
            modal_add_tip: "Dica: Se um site nÃ£o carregar (tela branca), use o botÃ£o de seta â†— no cartÃ£o para abrir externamente.",
            ai_title: "MultiVPlayers AI âœ¨",
            ai_key_label: "Gemini API Key:",
            ai_save_btn: "Salvar",
            ai_get_key: "Obter Chave GrÃ¡tis",
            tab_mosaic: "Mosaico MÃ¡gico",
            tab_session: "ğŸ§  SessÃ£o",
            tab_theme: "ğŸ¨ Temas",
            tab_copilot: "Co-Piloto",
            mosaic_desc: "A IA pesquisa vÃ­deos reais na internet e monta o layout para vocÃª.",
            mosaic_btn: "âœ¨ Gerar Mosaico",
            session_desc: "A IA analisa seus vÃ­deos abertos para organizar sua experiÃªncia.",
            session_name_title: "ğŸ·ï¸ Nomear SessÃ£o",
            session_name_desc: "Cria um tÃ­tulo Ã©pico baseado no que vocÃª estÃ¡ assistindo.",
            session_name_btn: "Gerar TÃ­tulo",
            session_expand_title: "â• Expandir SessÃ£o",
            session_expand_desc: "A IA busca e adiciona 2 vÃ­deos que combinam com o que jÃ¡ estÃ¡ na tela.",
            session_expand_btn: "Expandir Magic (+2)",
            session_bgm_title: "ğŸµ DJ de Ambiente (BGM)",
            session_bgm_desc: "Adiciona uma mÃºsica de fundo do YouTube que combina com os vÃ­deos.",
            session_bgm_btn: "Sugerir & Adicionar",
            theme_desc: "Descreva uma atmosfera e a IA mudarÃ¡ as cores do site.",
            theme_btn: "ğŸ¨ Aplicar Tema",
            theme_reset: "Resetar PadrÃ£o",
            copilot_msg: "OlÃ¡! Sou seu assistente. Pergunte sobre jogos, estratÃ©gias ou qualquer coisa!",
            // Placeholders
            p_url: "https://... ou <iframe...>",
            p_mosaic: "Ex: 'Torneio de CS2 ao vivo' ou 'MÃºsica Lo-Fi Relaxante'",
            p_theme: "Ex: 'Cyberpunk Neon', 'Floresta Escura', 'Clean White'",
            p_chat: "Sua pergunta...",
            p_key: "Cole sua chave aqui..."
        },
        en: {
            error_protocol: "âš ï¸ ERROR: File opened directly. Use a local server (Live Server) for Twitch to work.",
            header_ai: "âœ¨ AI Tools",
            header_add: "+ Add",
            header_chat: "ğŸ’¬ Chat",
            chat_title: "Chats",
            chat_hide: "Hide",
            chat_select_default: "Select a channel...",
            chat_placeholder: "Select a channel above to load the chat.",
            modal_add_title: "Add Content",
            modal_add_desc: "Paste URL or HTML code (iframe/embed).",
            modal_add_btn: "Add to Mosaic",
            modal_add_tip: "Tip: If a site doesn't load (white screen), use the arrow button â†— on the card to open externally.",
            ai_title: "MultiVPlayers AI âœ¨",
            ai_key_label: "Gemini API Key:",
            ai_save_btn: "Save",
            ai_get_key: "Get Free Key",
            tab_mosaic: "Magic Mosaic",
            tab_session: "ğŸ§  Session",
            tab_theme: "ğŸ¨ Themes",
            tab_copilot: "Co-Pilot",
            mosaic_desc: "AI searches for real videos online and builds the layout for you.",
            mosaic_btn: "âœ¨ Generate Mosaic",
            session_desc: "AI analyzes your open videos to organize your experience.",
            session_name_title: "ğŸ·ï¸ Name Session",
            session_name_desc: "Creates an epic title based on what you are watching.",
            session_name_btn: "Generate Title",
            session_expand_title: "â• Expand Session",
            session_expand_desc: "AI finds and adds 2 videos that match what's on screen.",
            session_expand_btn: "Magic Expand (+2)",
            session_bgm_title: "ğŸµ Ambience DJ (BGM)",
            session_bgm_desc: "Adds background music from YouTube that matches the videos.",
            session_bgm_btn: "Suggest & Add",
            theme_desc: "Describe an atmosphere and AI will change site colors.",
            theme_btn: "ğŸ¨ Apply Theme",
            theme_reset: "Reset Default",
            copilot_msg: "Hello! I'm your assistant. Ask about games, strategies, or anything!",
            p_url: "https://... or <iframe...>",
            p_mosaic: "Ex: 'Live CS2 tournament' or 'Relaxing Lo-Fi Music'",
            p_theme: "Ex: 'Cyberpunk Neon', 'Dark Forest', 'Clean White'",
            p_chat: "Your question...",
            p_key: "Paste your key here..."
        },
        es: {
            error_protocol: "âš ï¸ ERROR: Archivo abierto directamente. Usa un servidor local para que Twitch funcione.",
            header_ai: "âœ¨ Herr. IA",
            header_add: "+ AÃ±adir",
            header_chat: "ğŸ’¬ Chat",
            chat_title: "Chats",
            chat_hide: "Ocultar",
            chat_select_default: "Selecciona un canal...",
            chat_placeholder: "Selecciona un canal arriba para cargar el chat.",
            modal_add_title: "AÃ±adir Contenido",
            modal_add_desc: "Pega URL o cÃ³digo HTML (iframe/embed).",
            modal_add_btn: "AÃ±adir al Mosaico",
            modal_add_tip: "Consejo: Si un sitio no carga, usa el botÃ³n de flecha â†— en la tarjeta.",
            ai_title: "MultiVPlayers IA âœ¨",
            ai_key_label: "Clave API Gemini:",
            ai_save_btn: "Guardar",
            ai_get_key: "Obtener Clave Gratis",
            tab_mosaic: "Mosaico MÃ¡gico",
            tab_session: "ğŸ§  SesiÃ³n",
            tab_theme: "ğŸ¨ Temas",
            tab_copilot: "Co-Piloto",
            mosaic_desc: "La IA busca videos reales y monta el diseÃ±o por ti.",
            mosaic_btn: "âœ¨ Generar Mosaico",
            session_desc: "La IA analiza tus videos para organizar tu experiencia.",
            session_name_title: "ğŸ·ï¸ Nombrar SesiÃ³n",
            session_name_desc: "Crea un tÃ­tulo Ã©pico basado en lo que estÃ¡s viendo.",
            session_name_btn: "Generar TÃ­tulo",
            session_expand_title: "â• Expandir SesiÃ³n",
            session_expand_desc: "La IA encuentra y aÃ±ade 2 videos que combinan.",
            session_expand_btn: "ExpansiÃ³n MÃ¡gica (+2)",
            session_bgm_title: "ğŸµ DJ de Ambiente",
            session_bgm_desc: "AÃ±ade mÃºsica de fondo de YouTube que combina.",
            session_bgm_btn: "Sugerir y AÃ±adir",
            theme_desc: "Describe una atmÃ³sfera y la IA cambiarÃ¡ los colores.",
            theme_btn: "ğŸ¨ Aplicar Tema",
            theme_reset: "Restablecer",
            copilot_msg: "Â¡Hola! Soy tu asistente. Â¡Pregunta sobre juegos o estrategias!",
            p_url: "https://... o <iframe...>",
            p_mosaic: "Ej: 'Torneo CS2 en vivo' o 'MÃºsica Lo-Fi'",
            p_theme: "Ej: 'Cyberpunk NeÃ³n', 'Bosque Oscuro'",
            p_chat: "Tu pregunta...",
            p_key: "Pega tu clave aquÃ­..."
        },
        fr: {
            header_ai: "âœ¨ Outils IA", header_add: "+ Ajouter", header_chat: "ğŸ’¬ Chat",
            chat_title: "Chats", chat_hide: "Masquer", chat_select_default: "SÃ©lectionnez...",
            chat_placeholder: "SÃ©lectionnez un canal ci-dessus.",
            modal_add_title: "Ajouter Contenu", modal_add_desc: "Collez URL ou code HTML.",
            modal_add_btn: "Ajouter au MosaÃ¯que", modal_add_tip: "Astuce: Utilisez la flÃ¨che â†— si le site ne charge pas.",
            ai_title: "MultiVPlayers IA âœ¨", ai_key_label: "ClÃ© API Gemini:", ai_save_btn: "Sauver",
            tab_mosaic: "MosaÃ¯que Magique", tab_session: "ğŸ§  Session", tab_theme: "ğŸ¨ ThÃ¨mes", tab_copilot: "Co-Pilote",
            mosaic_btn: "âœ¨ GÃ©nÃ©rer MosaÃ¯que", session_name_btn: "GÃ©nÃ©rer Titre", session_expand_btn: "Ã‰tendre (+2)",
            session_bgm_btn: "SuggÃ©rer & Ajouter", theme_btn: "ğŸ¨ Appliquer ThÃ¨me", theme_reset: "RÃ©initialiser",
            copilot_msg: "Salut! Je suis votre assistant gamer.",
            p_url: "https://... ou <iframe...>", p_mosaic: "Ex: 'Tournoi CS2'", p_theme: "Ex: 'Cyberpunk'", p_chat: "Votre question...", p_key: "Votre clÃ© ici..."
        },
        de: {
            header_ai: "âœ¨ KI-Tools", header_add: "+ HinzufÃ¼gen", header_chat: "ğŸ’¬ Chat",
            chat_title: "Chats", chat_hide: "Verbergen", chat_select_default: "WÃ¤hle einen Kanal...",
            chat_placeholder: "WÃ¤hle oben einen Kanal aus.",
            modal_add_title: "Inhalt hinzufÃ¼gen", modal_add_desc: "URL oder HTML-Code einfÃ¼gen.",
            modal_add_btn: "Zum Mosaik", modal_add_tip: "Tipp: Nutze den Pfeil â†—, wenn die Seite nicht lÃ¤dt.",
            ai_title: "MultiVPlayers KI âœ¨", ai_key_label: "Gemini API Key:", ai_save_btn: "Speichern",
            tab_mosaic: "Magisches Mosaik", tab_session: "ğŸ§  Sitzung", tab_theme: "ğŸ¨ Themen", tab_copilot: "Co-Pilot",
            mosaic_btn: "âœ¨ Mosaik erstellen", session_name_btn: "Titel generieren", session_expand_btn: "Erweitern (+2)",
            session_bgm_btn: "BGM hinzufÃ¼gen", theme_btn: "ğŸ¨ Thema anwenden", theme_reset: "ZurÃ¼cksetzen",
            copilot_msg: "Hallo! Ich bin dein Gaming-Assistent.",
            p_url: "https://... oder <iframe...>", p_mosaic: "Bsp: 'CS2 Live'", p_theme: "Bsp: 'Cyberpunk'", p_chat: "Deine Frage...", p_key: "SchlÃ¼ssel hier..."
        },
        it: {
            header_ai: "âœ¨ Strumenti IA", header_add: "+ Aggiungi", header_chat: "ğŸ’¬ Chat",
            chat_title: "Chat", chat_hide: "Nascondi", chat_select_default: "Seleziona canale...",
            chat_placeholder: "Seleziona un canale sopra.",
            modal_add_title: "Aggiungi Contenuto", modal_add_desc: "Incolla URL o codice HTML.",
            modal_add_btn: "Aggiungi al Mosaico", modal_add_tip: "Consiglio: Usa la freccia â†— se il sito non carica.",
            ai_title: "MultiVPlayers IA âœ¨", ai_key_label: "Chiave API Gemini:", ai_save_btn: "Salva",
            tab_mosaic: "Mosaico Magico", tab_session: "ğŸ§  Sessione", tab_theme: "ğŸ¨ Temi", tab_copilot: "Co-Pilota",
            mosaic_btn: "âœ¨ Genera Mosaico", session_name_btn: "Genera Titolo", session_expand_btn: "Espandi (+2)",
            session_bgm_btn: "Suggerisci BGM", theme_btn: "ğŸ¨ Applica Tema", theme_reset: "Resetta",
            copilot_msg: "Ciao! Sono il tuo assistente gamer.",
            p_url: "https://... o <iframe...>", p_mosaic: "Es: 'Torneo CS2'", p_theme: "Es: 'Cyberpunk'", p_chat: "La tua domanda...", p_key: "La tua chiave..."
        },
        ru: {
            header_ai: "âœ¨ Ğ˜Ğ˜ Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹", header_add: "+ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ", header_chat: "ğŸ’¬ Ğ§Ğ°Ñ‚",
            chat_title: "Ğ§Ğ°Ñ‚Ñ‹", chat_hide: "Ğ¡ĞºÑ€Ñ‹Ñ‚ÑŒ", chat_select_default: "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ĞºĞ°Ğ½Ğ°Ğ»...",
            chat_placeholder: "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ĞºĞ°Ğ½Ğ°Ğ» Ğ²Ñ‹ÑˆĞµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ñ‡Ğ°Ñ‚.",
            modal_add_title: "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚", modal_add_desc: "Ğ’ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ URL Ğ¸Ğ»Ğ¸ HTML ĞºĞ¾Ğ´.",
            modal_add_btn: "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² Ğ¼Ğ¾Ğ·Ğ°Ğ¸ĞºÑƒ", modal_add_tip: "Ğ¡Ğ¾Ğ²ĞµÑ‚: Ğ•ÑĞ»Ğ¸ ÑĞ°Ğ¹Ñ‚ Ğ½Ğµ Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑÑ, Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ â†—.",
            ai_title: "MultiVPlayers Ğ˜Ğ˜ âœ¨", ai_key_label: "ĞšĞ»ÑÑ‡ API Gemini:", ai_save_btn: "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ",
            tab_mosaic: "ĞœĞ°Ğ³Ğ¸Ñ", tab_session: "ğŸ§  Ğ¡ĞµÑÑĞ¸Ñ", tab_theme: "ğŸ¨ Ğ¢ĞµĞ¼Ñ‹", tab_copilot: "ĞšĞ¾-ĞŸĞ¸Ğ»Ğ¾Ñ‚",
            mosaic_btn: "âœ¨ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¼Ğ¾Ğ·Ğ°Ğ¸ĞºÑƒ", session_name_btn: "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº", session_expand_btn: "Ğ Ğ°ÑÑˆĞ¸Ñ€Ğ¸Ñ‚ÑŒ (+2)",
            session_bgm_btn: "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¼ÑƒĞ·Ñ‹ĞºÑƒ", theme_btn: "ğŸ¨ ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞ¼Ñƒ", theme_reset: "Ğ¡Ğ±Ñ€Ğ¾Ñ",
            copilot_msg: "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! Ğ¯ Ñ‚Ğ²Ğ¾Ğ¹ Ğ¸Ğ³Ñ€Ğ¾Ğ²Ğ¾Ğ¹ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚.",
            p_url: "https://... Ğ¸Ğ»Ğ¸ <iframe...>", p_mosaic: "ĞĞ°Ğ¿Ñ€: 'CS2 Ğ¢ÑƒÑ€Ğ½Ğ¸Ñ€'", p_theme: "ĞĞ°Ğ¿Ñ€: 'ĞšĞ¸Ğ±ĞµÑ€Ğ¿Ğ°Ğ½Ğº'", p_chat: "Ğ’Ğ°Ñˆ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ...", p_key: "Ğ’ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ ĞºĞ»ÑÑ‡..."
        },
        zh: {
            header_ai: "âœ¨ AIå·¥å…·", header_add: "+ æ·»åŠ ", header_chat: "ğŸ’¬ èŠå¤©",
            chat_title: "èŠå¤©å®¤", chat_hide: "éšè—", chat_select_default: "é€‰æ‹©é¢‘é“...",
            chat_placeholder: "è¯·åœ¨ä¸Šæ–¹é€‰æ‹©ä¸€ä¸ªé¢‘é“ã€‚",
            modal_add_title: "æ·»åŠ å†…å®¹", modal_add_desc: "ç²˜è´´ URL æˆ– HTML ä»£ç ã€‚",
            modal_add_btn: "æ·»åŠ åˆ°é©¬èµ›å…‹", modal_add_tip: "æç¤ºï¼šå¦‚æœç½‘ç«™æ— æ³•åŠ è½½ï¼Œè¯·ç‚¹å‡»å¡ç‰‡ä¸Šçš„ â†—ã€‚",
            ai_title: "MultiVPlayers AI âœ¨", ai_key_label: "Gemini API å¯†é’¥:", ai_save_btn: "ä¿å­˜",
            tab_mosaic: "é­”æ³•é©¬èµ›å…‹", tab_session: "ğŸ§  ä¼šè¯", tab_theme: "ğŸ¨ ä¸»é¢˜", tab_copilot: "å‰¯é©¾é©¶",
            mosaic_btn: "âœ¨ ç”Ÿæˆé©¬èµ›å…‹", session_name_btn: "ç”Ÿæˆæ ‡é¢˜", session_expand_btn: "æ‰©å±• (+2)",
            session_bgm_btn: "æ·»åŠ èƒŒæ™¯éŸ³ä¹", theme_btn: "ğŸ¨ åº”ç”¨ä¸»é¢˜", theme_reset: "é‡ç½®",
            copilot_msg: "ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„æ¸¸æˆåŠ©æ‰‹ã€‚",
            p_url: "https://... æˆ– <iframe...>", p_mosaic: "ä¾‹å¦‚ï¼š'CS2 ç›´æ’­'", p_theme: "ä¾‹å¦‚ï¼š'èµ›åšæœ‹å…‹'", p_chat: "ä½ çš„é—®é¢˜...", p_key: "åœ¨æ­¤ç²˜è´´å¯†é’¥..."
        },
        ja: {
            header_ai: "âœ¨ AIãƒ„ãƒ¼ãƒ«", header_add: "+ è¿½åŠ ", header_chat: "ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ",
            chat_title: "ãƒãƒ£ãƒƒãƒˆ", chat_hide: "éš ã™", chat_select_default: "ãƒãƒ£ãƒ³ãƒãƒ«ã‚’é¸æŠ...",
            chat_placeholder: "ãƒãƒ£ãƒƒãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã«ã¯ä¸Šã‹ã‚‰ãƒãƒ£ãƒ³ãƒãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚",
            modal_add_title: "ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¿½åŠ ", modal_add_desc: "URLã¾ãŸã¯HTMLã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã€‚",
            modal_add_btn: "ãƒ¢ã‚¶ã‚¤ã‚¯ã«è¿½åŠ ", modal_add_tip: "ãƒ’ãƒ³ãƒˆï¼šã‚µã‚¤ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œãªã„å ´åˆã¯ã€â†—ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚",
            ai_title: "MultiVPlayers AI âœ¨", ai_key_label: "Gemini APIã‚­ãƒ¼:", ai_save_btn: "ä¿å­˜",
            tab_mosaic: "é­”æ³•ã®ãƒ¢ã‚¶ã‚¤ã‚¯", tab_session: "ğŸ§  ã‚»ãƒƒã‚·ãƒ§ãƒ³", tab_theme: "ğŸ¨ ãƒ†ãƒ¼ãƒ", tab_copilot: "ã‚³ãƒ‘ã‚¤ãƒ­ãƒƒãƒˆ",
            mosaic_btn: "âœ¨ ãƒ¢ã‚¶ã‚¤ã‚¯ç”Ÿæˆ", session_name_btn: "ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ", session_expand_btn: "æ‹¡å¼µ (+2)",
            session_bgm_btn: "BGMã‚’è¿½åŠ ", theme_btn: "ğŸ¨ ãƒ†ãƒ¼ãƒé©ç”¨", theme_reset: "ãƒªã‚»ãƒƒãƒˆ",
            copilot_msg: "ã“ã‚“ã«ã¡ã¯ï¼ã‚ãªãŸã®ã‚²ãƒ¼ãƒ ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚",
            p_url: "https://... ã¾ãŸã¯ <iframe...>", p_mosaic: "ä¾‹: 'CS2 ãƒ©ã‚¤ãƒ–'", p_theme: "ä¾‹: 'ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯'", p_chat: "è³ªå•ã‚’å…¥åŠ›...", p_key: "ã‚­ãƒ¼ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘..."
        }
    };

    if (!currentHostname) {
        document.getElementById('fileProtocolWarning').style.display = 'block';
        document.querySelector('.video-area').style.marginTop = '40px';
        currentHostname = 'localhost';
    }

    // --- ReferÃªncias DOM ---
    const els = {
        fab: document.getElementById('fab'),
        chatFab: document.getElementById('toggleChatFab'),
        aiFab: document.getElementById('aiFab'),
        langSelect: document.getElementById('langSelect'), // Novo
        
        overlay: document.getElementById('urlInputOverlay'),
        aiOverlay: document.getElementById('aiOverlay'),
        
        input: document.getElementById('urlInput'),
        addBtn: document.getElementById('addUrlButton'),
        
        grid: document.getElementById('contentGrid'),
        sessionTitle: document.getElementById('sessionTitleHeader'),

        chatPanel: document.getElementById('chatPanel'),
        chatSelect: document.getElementById('chatSelect'),
        chatContainer: document.getElementById('chatContainer'),

        // AI Elements
        apiKeyInput: document.getElementById('apiKeyInput'),
        saveKeyBtn: document.getElementById('saveKeyBtn'),
        
        mosaicPrompt: document.getElementById('aiMosaicPrompt'),
        generateBtn: document.getElementById('generateMosaicBtn'),
        mosaicStatus: document.getElementById('mosaicStatus'),
        
        sessionNameBtn: document.getElementById('aiSessionNameBtn'),
        expandSessionBtn: document.getElementById('aiExpandSessionBtn'), 
        ambienceBtn: document.getElementById('aiAmbienceBtn'),
        sessionStatus: document.getElementById('sessionStatus'),
        
        themePrompt: document.getElementById('aiThemePrompt'),
        themeBtn: document.getElementById('generateThemeBtn'),

        chatBox: document.getElementById('aiChatBox'),
        chatInput: document.getElementById('aiChatInput'),
        chatSend: document.getElementById('aiChatSend'),
        closeAiBtn: document.getElementById('closeAiBtn')
    };

    // --- InicializaÃ§Ã£o ---
    window.addEventListener('DOMContentLoaded', () => {
        loadData();
        loadApiKey();
        setLanguage(currentLang);
        window.addEventListener('resize', resizeGrid); 
    });

    // --- Language Logic ---
    els.langSelect.value = currentLang;
    els.langSelect.addEventListener('change', (e) => {
        setLanguage(e.target.value);
    });

    function setLanguage(lang) {
        currentLang = lang;
        localStorage.setItem(LANG_KEY, lang);
        
        const t = translations[lang] || translations['pt'];
        
        // Update text content
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.dataset.i18n;
            if (t[key]) el.textContent = t[key];
        });

        // Update placeholders
        if (t.p_url) els.input.placeholder = t.p_url;
        if (t.p_mosaic) els.mosaicPrompt.placeholder = t.p_mosaic;
        if (t.p_theme) els.themePrompt.placeholder = t.p_theme;
        if (t.p_chat) els.chatInput.placeholder = t.p_chat;
        if (t.p_key) els.apiKeyInput.placeholder = t.p_key;
    }

    // --- Event Listeners ---
    els.fab.onclick = () => toggleOverlay(els.overlay, true);
    els.overlay.onclick = (e) => { if(e.target === els.overlay) toggleOverlay(els.overlay, false); };
    
    els.aiFab.onclick = () => toggleOverlay(els.aiOverlay, true);
    els.aiOverlay.onclick = (e) => { if(e.target === els.aiOverlay) toggleOverlay(els.aiOverlay, false); };
    els.closeAiBtn.onclick = () => toggleOverlay(els.aiOverlay, false);

    els.addBtn.onclick = processManualInput;
    els.input.onkeypress = (e) => { if(e.key === 'Enter') processManualInput(); };
    els.chatFab.onclick = toggleChat;

    // AI Listeners
    els.saveKeyBtn.onclick = saveApiKey;
    els.generateBtn.onclick = handleMagicMosaic;
    els.themeBtn.onclick = handleThemeGen;
    els.chatSend.onclick = handleAiChat;
    els.chatInput.onkeypress = (e) => { if(e.key === 'Enter') handleAiChat(); };
    
    // Novos Listeners de SessÃ£o
    els.sessionNameBtn.onclick = handleSessionName;
    els.expandSessionBtn.onclick = handleExpandSession; 
    els.ambienceBtn.onclick = handleAmbienceSuggest;

    // --- Controle de UI ---
    function toggleOverlay(overlayElement, show) {
        overlayElement.classList.toggle('visible', show);
        if (show && overlayElement === els.overlay) els.input.focus();
    }

    function toggleChat() {
        els.chatPanel.classList.toggle('hidden');
    }

    function switchTab(tabName) {
        document.querySelectorAll('.ai-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.ai-content').forEach(c => c.classList.remove('active'));
        
        document.querySelector(`.ai-tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
        document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    // --- LÃ³gica Manual ---
    function processManualInput() {
        let rawInput = els.input.value.trim();
        if (!rawInput) return;
        processUrl(rawInput);
        els.input.value = '';
        toggleOverlay(els.overlay, false);
    }

    function processUrl(rawInput) {
        if (!rawInput.startsWith('http') && !rawInput.startsWith('<iframe') && !rawInput.startsWith('<embed')) {
            rawInput = 'https://' + rawInput;
        }

        const embedData = generateEmbed(rawInput);
        if (embedData) {
            createCard(rawInput, embedData);
            saveData(rawInput);
            return true;
        } else {
            alert('URL invÃ¡lida ou nÃ£o suportada.');
            return false;
        }
    }

    // --- GEMINI AI LOGIC ---

    function getApiKey() {
        let k = els.apiKeyInput.value.trim();
        if(!k) k = localStorage.getItem(API_KEY_LS);
        if(!k) k = systemApiKey;
        return k;
    }

    function loadApiKey() {
        const k = localStorage.getItem(API_KEY_LS);
        if(k) els.apiKeyInput.value = k;
    }

    function saveApiKey() {
        const k = els.apiKeyInput.value.trim();
        if(k) {
            localStorage.setItem(API_KEY_LS, k);
            alert('Chave API salva!');
        }
    }

    async function callGemini(payload) {
        const key = getApiKey();
        if (!key) throw new Error("Por favor, insira sua Gemini API Key nas configuraÃ§Ãµes acima.");

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
        
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error?.message || 'Erro na API Gemini');
        }
        return await response.json();
    }

    // 1. Mosaico MÃ¡gico
    async function handleMagicMosaic() {
        const prompt = els.mosaicPrompt.value.trim();
        if (!prompt) return;

        els.generateBtn.disabled = true;
        els.mosaicStatus.innerHTML = "Pesquisando... <span class='loading-dots'></span>";

        try {
            const payload = {
                contents: [{ 
                    parts: [{ 
                        text: `Encontre 3 ou 4 vÃ­deos ou lives (YouTube/Twitch) REAIS sobre: "${prompt}". 
                        Retorne APENAS um Array JSON com as URLs. Ex: ["https://youtube.com/watch?v=...", "https://twitch.tv/..."].` 
                    }] 
                }],
                tools: [{ "google_search": {} }] 
            };

            const data = await callGemini(payload);
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            let jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
            let urls = JSON.parse(jsonStr);

            if (Array.isArray(urls)) {
                let count = 0;
                urls.forEach(url => { if (processUrl(url)) count++; });
                els.mosaicStatus.innerText = `Feito! ${count} vÃ­deos.`;
                els.mosaicPrompt.value = '';
                toggleOverlay(els.aiOverlay, false);
            } else {
                throw new Error("Formato invÃ¡lido.");
            }
        } catch (e) {
            console.error(e);
            els.mosaicStatus.innerText = "Erro: " + e.message;
        } finally {
            els.generateBtn.disabled = false;
        }
    }
    
    // 2. Gerenciador de SessÃ£o
    function getCurrentUrls() {
        const cards = document.querySelectorAll('.content-card');
        return Array.from(cards).map(c => c.dataset.url);
    }

    async function handleSessionName() {
        const urls = getCurrentUrls();
        if (urls.length === 0) return alert("Adicione vÃ­deos antes de gerar um tÃ­tulo!");
        
        els.sessionNameBtn.disabled = true;
        els.sessionNameBtn.innerText = "Gerando...";
        
        try {
            // Se o idioma nÃ£o for PT, instrui a IA a gerar no idioma correto
            const langInstruction = currentLang !== 'pt' ? `(em idioma ${currentLang})` : '(em PortuguÃªs)';
            
            const payload = {
                contents: [{ parts: [{ text: `Analise estas URLs/Canais: ${JSON.stringify(urls)}. Crie um TÃ­tulo curto, criativo e empolgante para esta sessÃ£o multitelas ${langInstruction} com um Emoji. Retorne APENAS o texto do tÃ­tulo.` }] }],
                tools: [{ "google_search": {} }] 
            };
            const data = await callGemini(payload);
            const title = data.candidates?.[0]?.content?.parts?.[0]?.text || "SessÃ£o Multitelas";
            
            els.sessionTitle.innerText = title.replace(/["']/g, ""); 
            els.sessionTitle.classList.add('visible'); 
            toggleOverlay(els.aiOverlay, false);
            
        } catch(e) {
            alert("Erro: " + e.message);
        } finally {
            els.sessionNameBtn.disabled = false;
            els.sessionNameBtn.innerText = "Gerar TÃ­tulo"; // Reseta texto
            setLanguage(currentLang); // Restaura texto traduzido correto
        }
    }
    
    async function handleExpandSession() {
        const urls = getCurrentUrls();
        if (urls.length === 0) return alert("Adicione algo primeiro para a IA expandir!");

        els.expandSessionBtn.disabled = true;
        els.expandSessionBtn.innerText = "Pesquisando...";
        
        try {
            const payload = {
                contents: [{ 
                    parts: [{ 
                        text: `Contexto: O usuÃ¡rio estÃ¡ assistindo a estes vÃ­deos/streams: ${JSON.stringify(urls)}.
                        Tarefa: Encontre MAIS 2 vÃ­deos ou streams (YouTube ou Twitch) que complementem perfeitamente esta sessÃ£o.
                        Requisito: Retorne APENAS um Array JSON com 2 URLs. Ex: ["https://...", "https://..."].` 
                    }] 
                }],
                tools: [{ "google_search": {} }] 
            };

            const data = await callGemini(payload);
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            let jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
            let newUrls = JSON.parse(jsonStr);

            if (Array.isArray(newUrls)) {
                let added = 0;
                newUrls.forEach(url => { if (processUrl(url)) added++; });
                els.sessionStatus.innerText = `+${added} videos!`;
                toggleOverlay(els.aiOverlay, false);
            } else {
                throw new Error("Formato invÃ¡lido.");
            }
        } catch (e) {
             els.sessionStatus.innerText = "Erro: " + e.message;
        } finally {
            els.expandSessionBtn.disabled = false;
            setLanguage(currentLang);
        }
    }

    async function handleAmbienceSuggest() {
        const urls = getCurrentUrls();
        if (urls.length === 0) return alert("Adicione vÃ­deos primeiro!");

        els.ambienceBtn.disabled = true;
        els.ambienceBtn.innerText = "Pesquisando...";
        
        try {
            const payload = {
                contents: [{ parts: [{ text: `Com base nestes streams: ${JSON.stringify(urls)}. Sugira e encontre UMA URL de vÃ­deo do YouTube para mÃºsica de fundo/ambiente (lofi, Ã©pica, chuva, etc) que combine perfeitamente. Retorne APENAS a URL.` }] }],
                tools: [{ "google_search": {} }] 
            };
            const data = await callGemini(payload);
            let url = data.candidates?.[0]?.content?.parts?.[0]?.text;
            
            const urlMatch = url.match(/https?:\/\/[^\s]+/);
            if (urlMatch) {
                processUrl(urlMatch[0]);
                els.sessionStatus.innerText = "â™« BGM Add!";
            } else {
                throw new Error("NÃ£o encontrei uma URL vÃ¡lida.");
            }
            
        } catch(e) {
            els.sessionStatus.innerText = "Erro: " + e.message;
        } finally {
            els.ambienceBtn.disabled = false;
            setLanguage(currentLang);
        }
    }

    // 3. Gerador de Temas
    async function handleThemeGen() {
        const theme = els.themePrompt.value.trim();
        if (!theme) return;
        
        els.themeBtn.disabled = true;
        els.themeBtn.innerText = "...";

        try {
            const payload = {
                contents: [{ parts: [{ text: `Gere uma paleta CSS para um tema: "${theme}". Retorne APENAS JSON: bgColor (escuro), cardBg, sidebarBg, textColor, accentColor, borderColor.` }] }]
            };
            
            const data = await callGemini(payload);
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            let jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
            const colors = JSON.parse(jsonStr);
            
            const r = document.documentElement.style;
            r.setProperty('--bg-color', colors.bgColor);
            r.setProperty('--card-bg', colors.cardBg);
            r.setProperty('--sidebar-bg', colors.sidebarBg);
            r.setProperty('--text-color', colors.textColor);
            r.setProperty('--accent-color', colors.accentColor);
            r.setProperty('--border-color', colors.borderColor);
            
            els.themePrompt.value = '';
            toggleOverlay(els.aiOverlay, false);
        } catch(e) {
            alert("Erro: " + e.message);
        } finally {
            els.themeBtn.disabled = false;
            setLanguage(currentLang);
        }
    }

    function resetTheme() {
        const r = document.documentElement.style;
        r.removeProperty('--bg-color');
        r.removeProperty('--card-bg');
        r.removeProperty('--sidebar-bg');
        r.removeProperty('--text-color');
        r.removeProperty('--accent-color');
        r.removeProperty('--border-color');
    }

    // 4. Co-Piloto Chat
    async function handleAiChat() {
        const msg = els.chatInput.value.trim();
        if (!msg) return;

        addChatMsg(msg, 'user');
        els.chatInput.value = '';
        const loadingId = addChatMsg("...", 'ai', true);

        try {
            // Instrui a IA a responder no idioma selecionado
            const langInstruction = currentLang !== 'pt' ? `(em idioma ${currentLang})` : '(em PortuguÃªs)';
            const payload = {
                contents: [{ parts: [{ text: `VocÃª Ã© um assistente gamer. Responda curto ${langInstruction}. UsuÃ¡rio: ${msg}` }] }]
            };
            const data = await callGemini(payload);
            const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "Erro.";
            removeChatMsg(loadingId);
            addChatMsg(reply, 'ai');
        } catch (e) {
            removeChatMsg(loadingId);
            addChatMsg("Erro: " + e.message, 'ai');
        }
    }

    // 5. Raio-X IA
    async function handleAiInfo(url, toastId) {
        const toast = document.getElementById(toastId);
        toast.innerText = "IA...";
        toast.classList.add('visible');

        try {
            const langInstruction = currentLang !== 'pt' ? `(in language ${currentLang})` : '(em PortuguÃªs)';
            const payload = {
                contents: [{ 
                    parts: [{ 
                        text: `O que Ã© este link? "${url}". Responda em UMA frase curta ${langInstruction} dizendo quem Ã© o streamer ou sobre o que Ã© o site/vÃ­deo.` 
                    }] 
                }],
                tools: [{ "google_search": {} }] 
            };

            const data = await callGemini(payload);
            const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "?";
            toast.innerText = "âœ¨ " + reply;
            
            setTimeout(() => { toast.classList.remove('visible'); }, 6000);

        } catch (e) {
            toast.innerText = "Erro.";
            setTimeout(() => { toast.classList.remove('visible'); }, 3000);
        }
    }

    function addChatMsg(text, type, isLoading = false) {
        const div = document.createElement('div');
        div.className = `chat-msg ${type} ${isLoading ? 'loading-dots' : ''}`;
        div.innerText = text;
        div.id = 'msg-' + Date.now();
        els.chatBox.appendChild(div);
        els.chatBox.scrollTop = els.chatBox.scrollHeight;
        return div.id;
    }

    function removeChatMsg(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
    }

    function resizeGrid() {
        const cards = document.querySelectorAll('.content-card');
        const count = cards.length;
        
        if (count === 0) return;

        els.grid.style.justifyContent = "center";
        
        let width = '100%';
        let height = '50%'; 

        if (count === 1) {
            width = '100%';
            height = '100%';
        } else if (count === 2) {
            width = '100%'; 
            height = '50%';
        } else if (count === 3) {
            width = 'calc(50% - 10px)'; 
            height = '50%';
        } else if (count === 4) {
            width = 'calc(50% - 10px)'; 
            height = '50%';
        } else if (count >= 5 && count <= 6) {
            width = 'calc(33.33% - 10px)';
            height = '50%';
        } else {
            width = 'calc(33.33% - 10px)';
            height = '33.33%';
        }

        cards.forEach((card) => {
            card.style.flex = `0 0 ${width}`;
            card.style.maxWidth = width;
            
            const wrapper = card.querySelector('.iframe-wrapper');
            if (wrapper) {
                wrapper.style.paddingBottom = '0'; 
                wrapper.style.height = '100%'; 
            }
            
            if (count === 1) {
                card.style.height = '100%';
            } else {
                card.style.height = `calc(${height} - 10px)`;
            }
        });
    }

    function generateEmbed(url) {
        if (url.startsWith('<iframe') || url.startsWith('<embed')) {
            let cleanHtml = url;
            if (!cleanHtml.includes('width="100%"')) cleanHtml = cleanHtml.replace(/width=["']?\d+["']?/i, 'width="100%"');
            if (!cleanHtml.includes('height="100%"')) cleanHtml = cleanHtml.replace(/height=["']?\d+["']?/i, 'height="100%"');
            return { html: cleanHtml, type: 'custom' };
        }

        try {
            const urlObj = new URL(url);
            const hostname = urlObj.hostname.toLowerCase();
            const path = urlObj.pathname;

            if (hostname.includes('twitch.tv')) {
                const parents = new Set(['localhost', '127.0.0.1']);
                if (currentHostname) parents.add(currentHostname);
                const parentString = Array.from(parents).map(p => `&parent=${p}`).join('');

                const pathParts = path.split('/').filter(p => p);
                if (pathParts.length > 0 && !path.includes('/videos/') && !path.includes('/clip/')) {
                    const channel = pathParts[0];
                    addChatOption(channel);
                    return {
                        html: `<iframe src="https://player.twitch.tv/?channel=${channel}${parentString}&muted=false" allowfullscreen></iframe>`,
                        type: 'twitch_live',
                        channel: channel
                    };
                }
                if (path.includes('/videos/')) {
                    const videoId = path.split('/videos/')[1].split('/')[0];
                    return { html: `<iframe src="https://player.twitch.tv/?video=${videoId}${parentString}&autoplay=false" allowfullscreen></iframe>` };
                }
                if (path.includes('/clip/')) {
                     return { html: `<iframe src="https://clips.twitch.tv/embed?clip=${path.split('/').pop()}${parentString}&autoplay=false" allowfullscreen></iframe>`};
                }
            }

            if (hostname.includes('youtube.com') || hostname.includes('youtu.be')) {
                let videoId = '';
                if (hostname.includes('youtu.be')) videoId = path.substring(1);
                else if (path.includes('/embed/')) videoId = path.split('/embed/')[1];
                else if (path.includes('/shorts/')) videoId = path.split('/shorts/')[1];
                else videoId = urlObj.searchParams.get('v');

                if (videoId) {
                    return { html: `<iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>` };
                }
            }

            if (hostname.includes('kick.com')) {
                const parts = path.split('/').filter(p => p);
                if (parts.length > 0) {
                    return { html: `<iframe src="https://player.kick.com/${parts[0]}" allowfullscreen></iframe>` };
                }
            }

            return {
                html: `<iframe src="${url}" allowfullscreen sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-presentation"></iframe>`,
                type: 'generic'
            };

        } catch (e) {
            console.error(e);
            return null;
        }
    }

    function createCard(url, embedData) {
        const card = document.createElement('div');
        card.className = 'content-card';
        card.dataset.url = url;

        const header = document.createElement('div');
        header.className = 'card-header-overlay';
        
        const leftGroup = document.createElement('div');
        leftGroup.className = 'btn-group';
        
        const aiInfoBtn = document.createElement('button');
        aiInfoBtn.className = 'btn-icon btn-ai-info';
        aiInfoBtn.innerHTML = 'âœ¨'; 
        aiInfoBtn.title = 'Raio-X IA';
        
        const toastId = 'toast-' + Math.random().toString(36).substr(2, 9);
        const toast = document.createElement('div');
        toast.className = 'info-toast';
        toast.id = toastId;
        
        aiInfoBtn.onclick = () => handleAiInfo(url, toastId);
        leftGroup.appendChild(aiInfoBtn);

        const rightGroup = document.createElement('div');
        rightGroup.className = 'btn-group';

        const refreshBtn = document.createElement('button');
        refreshBtn.className = 'btn-icon';
        refreshBtn.innerHTML = '&#8635;';
        refreshBtn.title = 'Recarregar';
        refreshBtn.onclick = () => { const iframe = card.querySelector('iframe'); if(iframe) iframe.src = iframe.src; };

        const openBtn = document.createElement('button');
        openBtn.className = 'btn-icon';
        openBtn.innerHTML = '&#8599;'; 
        openBtn.title = 'Abrir';
        openBtn.onclick = () => window.open(url, '_blank');

        const closeBtn = document.createElement('button');
        closeBtn.className = 'btn-icon btn-remove';
        closeBtn.innerHTML = '&#10005;';
        closeBtn.title = 'Remover';
        closeBtn.onclick = () => {
            removeData(url);
            if(embedData.type === 'twitch_live') removeChatOption(embedData.channel);
            card.remove();
            resizeGrid(); 
        };

        rightGroup.append(refreshBtn, openBtn, closeBtn);
        header.appendChild(leftGroup);
        header.appendChild(rightGroup);

        const wrapper = document.createElement('div');
        wrapper.className = 'iframe-wrapper';
        wrapper.innerHTML = embedData.html;

        card.appendChild(header);
        card.appendChild(toast);
        card.appendChild(wrapper);
        els.grid.appendChild(card);
        
        resizeGrid(); 
    }

    function addChatOption(channel) {
        if (!twitchChannels.includes(channel)) {
            twitchChannels.push(channel);
            renderChatOptions();
            if (twitchChannels.length === 1) {
                els.chatSelect.value = channel;
                changeChat();
            }
        }
    }

    function removeChatOption(channel) {
        twitchChannels = twitchChannels.filter(c => c !== channel);
        renderChatOptions();
        if (els.chatSelect.value === channel) {
            els.chatSelect.value = "";
            changeChat();
        }
    }

    function renderChatOptions() {
        const current = els.chatSelect.value;
        while (els.chatSelect.options.length > 1) els.chatSelect.remove(1);
        twitchChannels.forEach(ch => {
            const opt = document.createElement('option');
            opt.value = ch;
            opt.textContent = ch;
            els.chatSelect.appendChild(opt);
        });
        if (twitchChannels.includes(current)) els.chatSelect.value = current;
    }

    function resetChat() {
        els.chatSelect.value = "";
        changeChat();
    }

    function changeChat() {
        const channel = els.chatSelect.value;
        if (channel) {
            const parents = new Set(['localhost', '127.0.0.1']);
            if (currentHostname) parents.add(currentHostname);
            const parentString = Array.from(parents).map(p => `&parent=${p}`).join('');
            els.chatContainer.innerHTML = `<iframe src="https://www.twitch.tv/embed/${channel}/chat?darkpopout${parentString}" width="100%" height="100%" frameborder="0"></iframe>`;
        } else {
            els.chatContainer.innerHTML = `<div class="chat-placeholder"><p>Selecione um canal.</p></div>`;
        }
    }

    function saveData(url) {
        const data = JSON.parse(localStorage.getItem(LS_KEY)) || [];
        if (!data.includes(url)) {
            data.push(url);
            localStorage.setItem(LS_KEY, JSON.stringify(data));
        }
    }

    function removeData(url) {
        let data = JSON.parse(localStorage.getItem(LS_KEY)) || [];
        data = data.filter(u => u !== url);
        localStorage.setItem(LS_KEY, JSON.stringify(data));
    }

    function loadData() {
        const data = JSON.parse(localStorage.getItem(LS_KEY)) || [];
        data.forEach(url => {
            const embedData = generateEmbed(url);
            if (embedData) createCard(url, embedData);
        });
        resizeGrid(); 
    }
  </script>
</body>
</html>
```

Agora seu site fala o mundo todo! Basta selecionar a bandeira no topo e a mÃ¡gica acontece. A IA tambÃ©m responderÃ¡ no idioma selecionado.
