<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
  <title>MultiVPlayers - Gemini Ultra</title>
  <style>
    /* --- Vari√°veis CSS para o Tema Din√¢mico --- */
    :root {
      --bg-color: #050505;
      --card-bg: #000000;
      --sidebar-bg: #111111;
      --text-color: #e0e0e0;
      --accent-color: #9146ff;
      --border-color: #333333;
      --header-height: 60px;
    }

    /* --- Estilos Gerais --- */
    body {
      margin: 0;
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      display: flex;
      flex-direction: column; /* Alterado para coluna para acomodar o header */
      height: 100vh;
      overflow: hidden;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.5s ease, color 0.5s ease;
    }

    /* --- Barra Superior (NOVO) --- */
    .app-top-bar {
        height: var(--header-height);
        background-color: var(--sidebar-bg);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        z-index: 100;
        flex-shrink: 0;
    }

    .app-logo {
        font-weight: 800;
        font-size: 1.2rem;
        background: linear-gradient(90deg, #4285f4, #9b72cb);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-right: 20px;
    }

    /* T√≠tulo da Sess√£o (Movido para o Header) */
    #sessionTitleHeader {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-color);
        opacity: 0; /* Come√ßa invis√≠vel */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex-grow: 1;
        text-align: center;
        margin: 0 20px;
        transition: opacity 0.5s ease;
    }
    #sessionTitleHeader.visible { opacity: 1; }

    /* Container de Bot√µes do Header */
    .header-actions {
        display: flex;
        gap: 10px;
    }

    /* Bot√µes da Toolbar (Estilo atualizado) */
    .toolbar-btn {
        background-color: rgba(255,255,255,0.05);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        height: 36px;
        padding: 0 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s;
    }
    .toolbar-btn:hover { background-color: rgba(255,255,255,0.1); border-color: var(--text-color); }
    
    .btn-primary { background-color: var(--accent-color); color: white; border: none; }
    .btn-primary:hover { filter: brightness(1.1); background-color: var(--accent-color); }
    
    .btn-ai { 
        background: linear-gradient(135deg, rgba(66, 133, 244, 0.2), rgba(155, 114, 203, 0.2)); 
        border-color: #9b72cb; 
        color: #d0bfff;
    }
    .btn-ai:hover { background: linear-gradient(135deg, rgba(66, 133, 244, 0.4), rgba(155, 114, 203, 0.4)); color: white; }


    /* --- Layout Principal (Abaixo do Header) --- */
    .main-container {
        display: flex;
        flex: 1;
        overflow: hidden;
        position: relative;
    }

    /* --- Aviso de Protocolo FILE --- */
    #fileProtocolWarning {
        display: none;
        background-color: #aa0000;
        color: white;
        padding: 5px;
        text-align: center;
        font-weight: bold;
        font-size: 12px;
    }

    /* --- √Årea de Mosaico --- */
    .video-area {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      /* Centraliza conte√∫do na horizontal (para √≠mpares ficarem no meio) */
      justify-content: center;
      /* Centraliza conte√∫do na vertical se sobrar espa√ßo */
      align-content: center; 
      padding: 10px;
      gap: 10px;
      overflow-y: auto;
      background-color: var(--bg-color);
      transition: background-color 0.5s ease;
      position: relative;
    }

    .video-area::-webkit-scrollbar { width: 8px; }
    .video-area::-webkit-scrollbar-track { background: var(--bg-color); }
    .video-area::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
    .video-area::-webkit-scrollbar-thumb:hover { background: #555; }

    /* O flex-basis agora √© controlado via JS (resizeGrid) */
    .content-card {
      background-color: var(--card-bg);
      position: relative;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 10px 20px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease; 
      /* Altura ser√° injetada pelo JS para preencher a tela */
    }
    
    .content-card:hover { border-color: var(--accent-color); }

    /* --- Container do Iframe --- */
    .iframe-wrapper {
      position: relative;
      width: 100%;
      height: 100%; /* For√ßa preencher o card */
      background: #000;
      flex-grow: 1;
      transition: all 0.3s ease;
    }

    .iframe-wrapper iframe, 
    .iframe-wrapper object, 
    .iframe-wrapper embed {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      border: none;
    }

    /* --- Barra de Ferramentas do Cart√£o --- */
    .card-header-overlay {
        position: absolute;
        top: 0; left: 0; width: 100%;
        height: 40px;
        background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
        z-index: 20;
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 5px;
        box-sizing: border-box;
        pointer-events: none;
    }
    .content-card:hover .card-header-overlay { opacity: 1; }

    .btn-group { display: flex; gap: 5px; pointer-events: auto; }

    .btn-icon {
        background: rgba(20, 20, 20, 0.9);
        color: #fff;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        width: 28px; height: 28px;
        cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        font-size: 14px;
        transition: all 0.2s;
    }
    .btn-icon:hover { background: var(--accent-color); border-color: var(--accent-color); }
    .btn-remove:hover { background: #d32f2f; border-color: #d32f2f; }
    .btn-ai-info { border-color: #4285f4; color: #4285f4; }
    .btn-ai-info:hover { background: #4285f4; color: white; }

    /* --- Info Toast (Raio-X) --- */
    .info-toast {
        position: absolute;
        top: 40px;
        left: 10px; right: 10px;
        background: rgba(10, 10, 10, 0.95);
        border: 1px solid var(--accent-color);
        color: var(--text-color);
        padding: 10px;
        border-radius: 6px;
        font-size: 13px;
        z-index: 30;
        display: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.8);
        pointer-events: auto;
    }
    .info-toast.visible { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }

    /* --- Chat Panel --- */
    .chat-panel {
      width: 360px;
      max-width: 100%;
      background-color: var(--sidebar-bg);
      display: flex;
      flex-direction: column;
      border-left: 1px solid var(--border-color);
      transition: all 0.5s ease;
      z-index: 50;
    }
    
    .chat-panel.hidden { margin-right: -360px; display: flex !important; }

    .chat-header {
      padding: 10px;
      background-color: rgba(255,255,255,0.05);
      border-bottom: 1px solid var(--border-color);
      display: flex; justify-content: space-between; align-items: center;
      gap: 10px;
    }

    .chat-select {
      flex-grow: 1;
      background-color: rgba(0,0,0,0.3);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      padding: 8px;
      border-radius: 4px;
      font-size: 13px;
      outline: none;
    }
    .chat-select:focus { border-color: var(--accent-color); }

    .chat-container { flex-grow: 1; position: relative; background: #000; }
    
    .chat-placeholder {
        display:flex; flex-direction:column; justify-content:center; align-items:center; 
        height:100%; color: var(--text-color); opacity: 0.5; text-align: center; padding: 20px; font-size: 14px;
    }

    /* --- Modais --- */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.9);
      backdrop-filter: blur(4px);
      display: flex; justify-content: center; align-items: center;
      z-index: 999;
      opacity: 0; visibility: hidden;
      transition: opacity 0.2s;
    }
    .modal-overlay.visible { opacity: 1; visibility: visible; }

    .modal-panel {
      background-color: var(--sidebar-bg);
      color: var(--text-color);
      padding: 30px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      box-shadow: 0 20px 50px rgba(0,0,0,0.8);
      width: 90%; max-width: 600px;
      display: flex; flex-direction: column; gap: 15px;
      max-height: 90vh; overflow-y: auto;
      transition: background-color 0.5s ease;
    }

    .modal-panel h2 { margin: 0; font-size: 22px; }
    
    .input-group input {
      padding: 15px;
      background-color: rgba(0,0,0,0.2);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      border-radius: 6px;
      font-size: 16px;
      outline: none;
      width: 100%; box-sizing: border-box;
    }
    .input-group input:focus { border-color: var(--accent-color); }

    .primary-btn {
      padding: 15px;
      background-color: var(--accent-color);
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
      text-transform: uppercase; letter-spacing: 0.5px;
      transition: background-color 0.3s;
    }
    .primary-btn:hover { filter: brightness(1.2); }
    .primary-btn:disabled { background-color: #555; cursor: not-allowed; }

    /* --- AI Panel Specifics --- */
    .ai-tabs {
        display: flex; gap: 10px; margin-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
        overflow-x: auto;
    }
    .ai-tab {
        background: transparent; border: none;
        color: var(--text-color); opacity: 0.6;
        cursor: pointer; padding: 8px 16px;
        font-weight: bold; border-radius: 4px;
        transition: 0.2s;
        white-space: nowrap;
    }
    .ai-tab.active { background: rgba(155, 114, 203, 0.2); opacity: 1; color: var(--accent-color); }
    .ai-tab:hover { opacity: 1; }

    .ai-content { display: none; }
    .ai-content.active { display: block; }

    .gemini-chat-box {
        background: rgba(0,0,0,0.2);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        height: 300px;
        overflow-y: auto;
        padding: 15px;
        margin-bottom: 10px;
        display: flex; flex-direction: column; gap: 10px;
    }
    .chat-msg {
        padding: 8px 12px; border-radius: 8px;
        max-width: 80%; line-height: 1.4; font-size: 14px;
    }
    .chat-msg.user { background: var(--border-color); align-self: flex-end; color: var(--text-color); }
    .chat-msg.ai {
        background: rgba(66, 133, 244, 0.15);
        align-self: flex-start; color: var(--text-color);
        border: 1px solid rgba(66, 133, 244, 0.3);
    }
    .loading-dots:after { content: ' .'; animation: dots 1s steps(5, end) infinite; }
    @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 80%, 100% { content: ''; } }

  </style>
</head>
<body>

  <!-- Aviso de Erro Cr√≠tico -->
  <div id="fileProtocolWarning">
      ‚ö†Ô∏è ERRO: Voc√™ abriu este arquivo diretamente do PC. A Twitch BLOQUEIA isso. 
      Use um servidor local (como "Live Server" no VSCode) ou hospede o site para funcionar.
  </div>

  <!-- Barra Superior (Header) -->
  <header class="app-top-bar">
      <div class="app-logo">MultiVPlayers</div>
      
      <div id="sessionTitleHeader"></div>

      <div class="header-actions">
          <button class="toolbar-btn btn-ai" id="aiFab" title="Intelig√™ncia Artificial">
              ‚ú® IA Tools
          </button>
          
          <button class="toolbar-btn btn-primary" id="fab" title="Adicionar URL">
              + Adicionar
          </button>
          
          <button class="toolbar-btn" id="toggleChatFab" title="Mostrar/Ocultar Chat">
              üí¨ Chat
          </button>
      </div>
  </header>

  <!-- Container Principal -->
  <div class="main-container">
      
      <!-- √Årea de Mosaico -->
      <div class="video-area" id="contentGrid">
          <!-- Cards ser√£o injetados aqui -->
      </div>

      <!-- Painel Lateral de Chat -->
      <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
          <strong>Chats</strong>
          <button onclick="toggleChat()" title="Ocultar" style="background:none; border:none; color:var(--text-color); cursor:pointer;">&#10005;</button>
        </div>
        
        <div style="padding: 10px; display:flex; gap:5px;">
            <select id="chatSelect" class="chat-select" onchange="changeChat()">
                <option value="" disabled selected>Selecione um canal...</option>
            </select>
            <button onclick="resetChat()" title="Limpar Sele√ß√£o" style="background:rgba(255,255,255,0.05); border:1px solid var(--border-color); color:var(--text-color); border-radius:4px; width:35px; cursor:pointer; display:flex; align-items:center; justify-content:center;">
                 &#10005;
            </button>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="chat-placeholder">
                <p>Selecione um canal acima para carregar o chat.</p>
            </div>
        </div>
      </div>

  </div>

  <!-- Modal de Input Manual -->
  <div class="modal-overlay" id="urlInputOverlay">
    <div class="modal-panel url-input-panel">
      <h2>Adicionar Conte√∫do</h2>
      <p style="opacity:0.7; font-size:14px; margin-top:-10px;">Cole URL ou c√≥digo HTML (iframe/embed).</p>
      
      <div class="input-group">
        <input type="text" id="urlInput" placeholder="https://... ou <iframe...>" autocomplete="off">
      </div>
      
      <button class="primary-btn" id="addUrlButton">Adicionar ao Mosaico</button>
      
      <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; font-size: 12px; opacity: 0.7;">
          <strong>Dica:</strong> Se um site n√£o carregar (tela branca), use o bot√£o de seta <span style="font-family:monospace;">&#8599;</span> no cart√£o para abrir externamente.
      </div>
    </div>
  </div>

  <!-- Modal IA (Gemini) -->
  <div class="modal-overlay" id="aiOverlay">
    <div class="modal-panel">
      <div style="display:flex; justify-content:space-between; align-items:center;">
          <h2 style="background: linear-gradient(90deg, #4285f4, #d96570); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">MultiVPlayers AI ‚ú®</h2>
          <button id="closeAiBtn" style="background:none; border:none; color:var(--text-color); cursor:pointer; font-size:20px;">&times;</button>
      </div>
      
      <!-- API Key Section -->
      <div id="apiKeySection" style="background:rgba(0,0,0,0.3); padding:10px; border-radius:6px; font-size:13px; margin-bottom:10px;">
          <div style="display:flex; gap:10px; align-items:center;">
              <span style="opacity:0.7;">Gemini API Key:</span>
              <input type="password" id="apiKeyInput" placeholder="Cole sua chave aqui..." style="background:rgba(0,0,0,0.5); border:1px solid var(--border-color); color:white; padding:5px; border-radius:4px; flex-grow:1;">
              <button id="saveKeyBtn" style="background:var(--border-color); color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Salvar</button>
          </div>
          <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:#4285f4; font-size:11px; text-decoration:none; margin-top:5px; display:inline-block;">Obter Chave Gr√°tis</a>
      </div>

      <div class="ai-tabs">
          <button class="ai-tab active" onclick="switchTab('mosaic')">Mosaico M√°gico</button>
          <button class="ai-tab" onclick="switchTab('session')">üß† Sess√£o</button>
          <button class="ai-tab" onclick="switchTab('theme')">üé® Temas</button>
          <button class="ai-tab" onclick="switchTab('copilot')">Co-Piloto</button>
      </div>

      <!-- Tab 1: Mosaico M√°gico -->
      <div id="tab-mosaic" class="ai-content active">
          <p style="opacity:0.8; font-size:14px;">A IA pesquisa v√≠deos reais na internet e monta o layout para voc√™.</p>
          <div class="input-group">
            <input type="text" id="aiMosaicPrompt" placeholder="Ex: 'Torneio de CS2 ao vivo' ou 'M√∫sica Lo-Fi Relaxante'" autocomplete="off">
          </div>
          <button class="primary-btn" id="generateMosaicBtn" style="margin-top:15px; width:100%;">‚ú® Gerar Mosaico</button>
          <div id="mosaicStatus" style="margin-top:10px; font-size:13px; opacity:0.7; font-style:italic;"></div>
      </div>

      <!-- Tab 2: Gerenciador de Sess√£o -->
      <div id="tab-session" class="ai-content">
          <p style="opacity:0.8; font-size:14px;">A IA analisa seus v√≠deos abertos para organizar sua experi√™ncia.</p>
          
          <div style="display:grid; gap:10px; margin-top:15px;">
              <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px;">
                  <strong style="display:block; margin-bottom:5px;">üè∑Ô∏è Nomear Sess√£o</strong>
                  <p style="font-size:12px; opacity:0.6; margin-bottom:10px;">Cria um t√≠tulo √©pico baseado no que voc√™ est√° assistindo.</p>
                  <button class="primary-btn" id="aiSessionNameBtn" style="width:100%; font-size:14px; padding:10px;">Gerar T√≠tulo</button>
              </div>
              
              <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px;">
                  <strong style="display:block; margin-bottom:5px;">‚ûï Expandir Sess√£o</strong>
                  <p style="font-size:12px; opacity:0.6; margin-bottom:10px;">A IA busca e adiciona 2 v√≠deos que combinam com o que j√° est√° na tela.</p>
                  <button class="primary-btn" id="aiExpandSessionBtn" style="width:100%; font-size:14px; padding:10px; background-color: #4285f4;">Expandir Magic (+2)</button>
              </div>

              <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px;">
                  <strong style="display:block; margin-bottom:5px;">üéµ DJ de Ambiente (BGM)</strong>
                  <p style="font-size:12px; opacity:0.6; margin-bottom:10px;">Adiciona uma m√∫sica de fundo do YouTube que combina com os v√≠deos.</p>
                  <button class="primary-btn" id="aiAmbienceBtn" style="width:100%; font-size:14px; padding:10px; background-color: #d96570;">Sugerir & Adicionar</button>
              </div>
          </div>
          <div id="sessionStatus" style="margin-top:10px; font-size:13px; opacity:0.7; text-align:center;"></div>
      </div>

      <!-- Tab 3: Gerador de Temas -->
      <div id="tab-theme" class="ai-content">
          <p style="opacity:0.8; font-size:14px;">Descreva uma atmosfera e a IA mudar√° as cores do site.</p>
          <div class="input-group">
            <input type="text" id="aiThemePrompt" placeholder="Ex: 'Cyberpunk Neon', 'Floresta Escura', 'Clean White'" autocomplete="off">
          </div>
          <button class="primary-btn" id="generateThemeBtn" style="margin-top:15px; width:100%;">üé® Aplicar Tema</button>
          <button onclick="resetTheme()" style="margin-top:10px; background:transparent; border:1px solid var(--border-color); color:var(--text-color); padding:8px; width:100%; border-radius:6px; cursor:pointer;">Resetar Padr√£o</button>
      </div>

      <!-- Tab 4: Co-Piloto -->
      <div id="tab-copilot" class="ai-content">
          <div class="gemini-chat-box" id="aiChatBox">
              <div class="chat-msg ai">Ol√°! Sou seu assistente. Pergunte sobre jogos, estrat√©gias ou qualquer coisa!</div>
          </div>
          <div style="display:flex; gap:10px;">
              <input type="text" id="aiChatInput" placeholder="Sua pergunta..." style="flex-grow:1; padding:10px; border-radius:6px; border:1px solid var(--border-color); background:rgba(0,0,0,0.2); color:var(--text-color);">
              <button id="aiChatSend" style="padding:0 15px; background:var(--accent-color); color:white; border:none; border-radius:6px; cursor:pointer;">‚û§</button>
          </div>
      </div>

    </div>
  </div>

  <script>
    // --- Configura√ß√µes e Estado ---
    const LS_KEY = 'multiVPlayers_final_data';
    const API_KEY_LS = 'gemini_api_key';
    let twitchChannels = [];
    let currentHostname = window.location.hostname;
    // IMPORTANTE: Insira sua chave manualmente se n√£o usar o painel da UI
    const systemApiKey = ""; 
    
    if (!currentHostname) {
        document.getElementById('fileProtocolWarning').style.display = 'block';
        document.querySelector('.video-area').style.marginTop = '40px';
        currentHostname = 'localhost';
    }

    // --- Refer√™ncias DOM ---
    const els = {
        fab: document.getElementById('fab'),
        chatFab: document.getElementById('toggleChatFab'),
        aiFab: document.getElementById('aiFab'),
        
        overlay: document.getElementById('urlInputOverlay'),
        aiOverlay: document.getElementById('aiOverlay'),
        
        input: document.getElementById('urlInput'),
        addBtn: document.getElementById('addUrlButton'),
        
        grid: document.getElementById('contentGrid'),
        sessionTitle: document.getElementById('sessionTitleHeader'),

        chatPanel: document.getElementById('chatPanel'),
        chatSelect: document.getElementById('chatSelect'),
        chatContainer: document.getElementById('chatContainer'),

        // AI Elements
        apiKeyInput: document.getElementById('apiKeyInput'),
        saveKeyBtn: document.getElementById('saveKeyBtn'),
        
        mosaicPrompt: document.getElementById('aiMosaicPrompt'),
        generateBtn: document.getElementById('generateMosaicBtn'),
        mosaicStatus: document.getElementById('mosaicStatus'),
        
        sessionNameBtn: document.getElementById('aiSessionNameBtn'),
        expandSessionBtn: document.getElementById('aiExpandSessionBtn'), 
        ambienceBtn: document.getElementById('aiAmbienceBtn'),
        sessionStatus: document.getElementById('sessionStatus'),
        
        themePrompt: document.getElementById('aiThemePrompt'),
        themeBtn: document.getElementById('generateThemeBtn'),

        chatBox: document.getElementById('aiChatBox'),
        chatInput: document.getElementById('aiChatInput'),
        chatSend: document.getElementById('aiChatSend'),
        closeAiBtn: document.getElementById('closeAiBtn')
    };

    // --- Inicializa√ß√£o ---
    window.addEventListener('DOMContentLoaded', () => {
        loadData();
        loadApiKey();
        window.addEventListener('resize', resizeGrid); // Re-calculate on window resize
    });

    // --- Event Listeners ---
    els.fab.onclick = () => toggleOverlay(els.overlay, true);
    els.overlay.onclick = (e) => { if(e.target === els.overlay) toggleOverlay(els.overlay, false); };
    
    els.aiFab.onclick = () => toggleOverlay(els.aiOverlay, true);
    els.aiOverlay.onclick = (e) => { if(e.target === els.aiOverlay) toggleOverlay(els.aiOverlay, false); };
    els.closeAiBtn.onclick = () => toggleOverlay(els.aiOverlay, false);

    els.addBtn.onclick = processManualInput;
    els.input.onkeypress = (e) => { if(e.key === 'Enter') processManualInput(); };
    els.chatFab.onclick = toggleChat;

    // AI Listeners
    els.saveKeyBtn.onclick = saveApiKey;
    els.generateBtn.onclick = handleMagicMosaic;
    els.themeBtn.onclick = handleThemeGen;
    els.chatSend.onclick = handleAiChat;
    els.chatInput.onkeypress = (e) => { if(e.key === 'Enter') handleAiChat(); };
    
    // Novos Listeners de Sess√£o
    els.sessionNameBtn.onclick = handleSessionName;
    els.expandSessionBtn.onclick = handleExpandSession; 
    els.ambienceBtn.onclick = handleAmbienceSuggest;

    // --- Controle de UI ---
    function toggleOverlay(overlayElement, show) {
        overlayElement.classList.toggle('visible', show);
        if (show && overlayElement === els.overlay) els.input.focus();
    }

    function toggleChat() {
        els.chatPanel.classList.toggle('hidden');
    }

    function switchTab(tabName) {
        document.querySelectorAll('.ai-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.ai-content').forEach(c => c.classList.remove('active'));
        
        document.querySelector(`.ai-tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
        document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    // --- L√≥gica Manual ---
    function processManualInput() {
        let rawInput = els.input.value.trim();
        if (!rawInput) return;
        processUrl(rawInput);
        els.input.value = '';
        toggleOverlay(els.overlay, false);
    }

    function processUrl(rawInput) {
        if (!rawInput.startsWith('http') && !rawInput.startsWith('<iframe') && !rawInput.startsWith('<embed')) {
            rawInput = 'https://' + rawInput;
        }

        const embedData = generateEmbed(rawInput);
        if (embedData) {
            createCard(rawInput, embedData);
            saveData(rawInput);
            return true;
        } else {
            alert('URL inv√°lida ou n√£o suportada.');
            return false;
        }
    }

    // --- GEMINI AI LOGIC ---

    function getApiKey() {
        let k = els.apiKeyInput.value.trim();
        if(!k) k = localStorage.getItem(API_KEY_LS);
        if(!k) k = systemApiKey;
        return k;
    }

    function loadApiKey() {
        const k = localStorage.getItem(API_KEY_LS);
        if(k) els.apiKeyInput.value = k;
    }

    function saveApiKey() {
        const k = els.apiKeyInput.value.trim();
        if(k) {
            localStorage.setItem(API_KEY_LS, k);
            alert('Chave API salva!');
        }
    }

    async function callGemini(payload) {
        const key = getApiKey();
        if (!key) throw new Error("Por favor, insira sua Gemini API Key nas configura√ß√µes acima.");

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
        
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error?.message || 'Erro na API Gemini');
        }
        return await response.json();
    }

    // 1. Mosaico M√°gico
    async function handleMagicMosaic() {
        const prompt = els.mosaicPrompt.value.trim();
        if (!prompt) return;

        els.generateBtn.disabled = true;
        els.mosaicStatus.innerHTML = "Pesquisando... <span class='loading-dots'></span>";

        try {
            const payload = {
                contents: [{ 
                    parts: [{ 
                        text: `Encontre 3 ou 4 v√≠deos ou lives (YouTube/Twitch) REAIS sobre: "${prompt}". 
                        Retorne APENAS um Array JSON com as URLs. Ex: ["https://youtube.com/watch?v=...", "https://twitch.tv/..."].` 
                    }] 
                }],
                tools: [{ "google_search": {} }] 
            };

            const data = await callGemini(payload);
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            let jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
            let urls = JSON.parse(jsonStr);

            if (Array.isArray(urls)) {
                let count = 0;
                urls.forEach(url => { if (processUrl(url)) count++; });
                els.mosaicStatus.innerText = `Feito! ${count} v√≠deos.`;
                els.mosaicPrompt.value = '';
                toggleOverlay(els.aiOverlay, false);
            } else {
                throw new Error("Formato inv√°lido.");
            }
        } catch (e) {
            console.error(e);
            els.mosaicStatus.innerText = "Erro: " + e.message;
        } finally {
            els.generateBtn.disabled = false;
        }
    }
    
    // 2. Gerenciador de Sess√£o
    function getCurrentUrls() {
        const cards = document.querySelectorAll('.content-card');
        return Array.from(cards).map(c => c.dataset.url);
    }

    async function handleSessionName() {
        const urls = getCurrentUrls();
        if (urls.length === 0) return alert("Adicione v√≠deos antes de gerar um t√≠tulo!");
        
        els.sessionNameBtn.disabled = true;
        els.sessionNameBtn.innerText = "Gerando...";
        
        try {
            const payload = {
                contents: [{ parts: [{ text: `Analise estas URLs/Canais: ${JSON.stringify(urls)}. Crie um T√≠tulo curto, criativo e empolgante para esta sess√£o multitelas (em Portugu√™s) com um Emoji. Ex: "üî• Noite de CS:GO", "üìö Deep Focus". Retorne APENAS o texto do t√≠tulo.` }] }],
                tools: [{ "google_search": {} }] 
            };
            const data = await callGemini(payload);
            const title = data.candidates?.[0]?.content?.parts?.[0]?.text || "Sess√£o Multitelas";
            
            els.sessionTitle.innerText = title.replace(/["']/g, ""); 
            els.sessionTitle.classList.add('visible'); // Mostra suavemente
            toggleOverlay(els.aiOverlay, false);
            
        } catch(e) {
            alert("Erro: " + e.message);
        } finally {
            els.sessionNameBtn.disabled = false;
            els.sessionNameBtn.innerText = "Gerar T√≠tulo";
        }
    }
    
    // --- NOVO: EXPANDIR SESS√ÉO ---
    async function handleExpandSession() {
        const urls = getCurrentUrls();
        if (urls.length === 0) return alert("Adicione algo primeiro para a IA expandir!");

        els.expandSessionBtn.disabled = true;
        els.expandSessionBtn.innerText = "Pesquisando...";
        
        try {
            const payload = {
                contents: [{ 
                    parts: [{ 
                        text: `Contexto: O usu√°rio est√° assistindo a estes v√≠deos/streams: ${JSON.stringify(urls)}.
                        Tarefa: Encontre MAIS 2 v√≠deos ou streams (YouTube ou Twitch) que complementem perfeitamente esta sess√£o.
                        Requisito: Retorne APENAS um Array JSON com 2 URLs. Ex: ["https://...", "https://..."].` 
                    }] 
                }],
                tools: [{ "google_search": {} }] 
            };

            const data = await callGemini(payload);
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            let jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
            let newUrls = JSON.parse(jsonStr);

            if (Array.isArray(newUrls)) {
                let added = 0;
                newUrls.forEach(url => { if (processUrl(url)) added++; });
                els.sessionStatus.innerText = `Sess√£o expandida! +${added} v√≠deos.`;
                toggleOverlay(els.aiOverlay, false);
            } else {
                throw new Error("Formato inv√°lido.");
            }
        } catch (e) {
             els.sessionStatus.innerText = "Erro ao expandir: " + e.message;
        } finally {
            els.expandSessionBtn.disabled = false;
            els.expandSessionBtn.innerText = "Expandir Magic (+2)";
        }
    }

    async function handleAmbienceSuggest() {
        const urls = getCurrentUrls();
        if (urls.length === 0) return alert("Adicione v√≠deos primeiro!");

        els.ambienceBtn.disabled = true;
        els.ambienceBtn.innerText = "Pesquisando...";
        
        try {
            const payload = {
                contents: [{ parts: [{ text: `Com base nestes streams: ${JSON.stringify(urls)}. Sugira e encontre UMA URL de v√≠deo do YouTube para m√∫sica de fundo/ambiente (lofi, √©pica, chuva, etc) que combine perfeitamente. Retorne APENAS a URL.` }] }],
                tools: [{ "google_search": {} }] 
            };
            const data = await callGemini(payload);
            let url = data.candidates?.[0]?.content?.parts?.[0]?.text;
            
            const urlMatch = url.match(/https?:\/\/[^\s]+/);
            if (urlMatch) {
                processUrl(urlMatch[0]);
                els.sessionStatus.innerText = "M√∫sica de ambiente adicionada!";
            } else {
                throw new Error("N√£o encontrei uma URL v√°lida.");
            }
            
        } catch(e) {
            els.sessionStatus.innerText = "Erro: " + e.message;
        } finally {
            els.ambienceBtn.disabled = false;
            els.ambienceBtn.innerText = "Sugerir & Adicionar";
        }
    }

    // 3. Gerador de Temas
    async function handleThemeGen() {
        const theme = els.themePrompt.value.trim();
        if (!theme) return;
        
        els.themeBtn.disabled = true;
        els.themeBtn.innerText = "Criando...";

        try {
            const payload = {
                contents: [{ parts: [{ text: `Gere uma paleta CSS para um tema: "${theme}". Retorne APENAS JSON: bgColor (escuro), cardBg, sidebarBg, textColor, accentColor, borderColor.` }] }]
            };
            
            const data = await callGemini(payload);
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            let jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
            const colors = JSON.parse(jsonStr);
            
            const r = document.documentElement.style;
            r.setProperty('--bg-color', colors.bgColor);
            r.setProperty('--card-bg', colors.cardBg);
            r.setProperty('--sidebar-bg', colors.sidebarBg);
            r.setProperty('--text-color', colors.textColor);
            r.setProperty('--accent-color', colors.accentColor);
            r.setProperty('--border-color', colors.borderColor);
            
            els.themePrompt.value = '';
            toggleOverlay(els.aiOverlay, false);
        } catch(e) {
            alert("Erro: " + e.message);
        } finally {
            els.themeBtn.disabled = false;
            els.themeBtn.innerText = "üé® Aplicar Tema";
        }
    }

    function resetTheme() {
        const r = document.documentElement.style;
        r.removeProperty('--bg-color');
        r.removeProperty('--card-bg');
        r.removeProperty('--sidebar-bg');
        r.removeProperty('--text-color');
        r.removeProperty('--accent-color');
        r.removeProperty('--border-color');
    }

    // 4. Co-Piloto Chat
    async function handleAiChat() {
        const msg = els.chatInput.value.trim();
        if (!msg) return;

        addChatMsg(msg, 'user');
        els.chatInput.value = '';
        const loadingId = addChatMsg("Pensando...", 'ai', true);

        try {
            const payload = {
                contents: [{ parts: [{ text: `Voc√™ √© um assistente gamer. Responda curto em PT-BR. Usu√°rio: ${msg}` }] }]
            };
            const data = await callGemini(payload);
            const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "Erro.";
            removeChatMsg(loadingId);
            addChatMsg(reply, 'ai');
        } catch (e) {
            removeChatMsg(loadingId);
            addChatMsg("Erro: " + e.message, 'ai');
        }
    }

    // 5. Raio-X IA
    async function handleAiInfo(url, toastId) {
        const toast = document.getElementById(toastId);
        toast.innerText = "Analisando com IA...";
        toast.classList.add('visible');

        try {
            const payload = {
                contents: [{ 
                    parts: [{ 
                        text: `O que √© este link? "${url}". Responda em UMA frase curta em Portugu√™s dizendo quem √© o streamer ou sobre o que √© o site/v√≠deo.` 
                    }] 
                }],
                tools: [{ "google_search": {} }] 
            };

            const data = await callGemini(payload);
            const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "N√£o consegui identificar.";
            toast.innerText = "‚ú® " + reply;
            
            // Auto hide ap√≥s 6 segundos
            setTimeout(() => { toast.classList.remove('visible'); }, 6000);

        } catch (e) {
            toast.innerText = "Erro ao analisar.";
            setTimeout(() => { toast.classList.remove('visible'); }, 3000);
        }
    }

    function addChatMsg(text, type, isLoading = false) {
        const div = document.createElement('div');
        div.className = `chat-msg ${type} ${isLoading ? 'loading-dots' : ''}`;
        div.innerText = text;
        div.id = 'msg-' + Date.now();
        els.chatBox.appendChild(div);
        els.chatBox.scrollTop = els.chatBox.scrollHeight;
        return div.id;
    }

    function removeChatMsg(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
    }

    // --- Grid Resize Logic (Updated for "Pir√¢mide Invertida" and Full Height) ---
    function resizeGrid() {
        const cards = document.querySelectorAll('.content-card');
        const count = cards.length;
        
        // Reset b√°sico
        if (count === 0) return;

        // Container adjustments
        els.grid.style.justifyContent = "center";
        
        let width = '100%';
        let height = '50%'; // Padr√£o

        if (count === 1) {
            width = '100%';
            height = '100%';
        } else if (count === 2) {
            width = '100%'; // Vertical Stack: Um em cima, um embaixo
            height = '50%';
        } else if (count === 3) {
            width = 'calc(50% - 10px)'; // Pir√¢mide Invertida (2 em cima, 1 embaixo centralizado pelo justify-content)
            height = '50%';
        } else if (count === 4) {
            width = 'calc(50% - 10px)'; // 2x2
            height = '50%';
        } else if (count >= 5 && count <= 6) {
            width = 'calc(33.33% - 10px)';
            height = '50%';
        } else {
            width = 'calc(33.33% - 10px)';
            height = '33.33%';
        }

        cards.forEach((card) => {
            // Aplica largura
            card.style.flex = `0 0 ${width}`;
            card.style.maxWidth = width;
            
            // Aplica altura
            // IMPORTANTE: Removemos padding-bottom do wrapper para usar altura fixa real
            const wrapper = card.querySelector('.iframe-wrapper');
            if (wrapper) {
                wrapper.style.paddingBottom = '0'; // Remove aspect ratio hack
                wrapper.style.height = '100%'; // Enche o card
            }
            
            // Ajuste fino para altura do card
            // Se for 1, ocupa 100% da √°rea vis√≠vel (menos margens)
            if (count === 1) {
                card.style.height = '100%';
            } else {
                // Calcula altura baseada na view port dispon√≠vel da √°rea de v√≠deo
                // Subtrai um pouco para gaps (aprox 20px)
                card.style.height = `calc(${height} - 10px)`;
            }
        });
    }

    // --- L√≥gica de Embed ---
    function generateEmbed(url) {
        if (url.startsWith('<iframe') || url.startsWith('<embed')) {
            let cleanHtml = url;
            if (!cleanHtml.includes('width="100%"')) cleanHtml = cleanHtml.replace(/width=["']?\d+["']?/i, 'width="100%"');
            if (!cleanHtml.includes('height="100%"')) cleanHtml = cleanHtml.replace(/height=["']?\d+["']?/i, 'height="100%"');
            return { html: cleanHtml, type: 'custom' };
        }

        try {
            const urlObj = new URL(url);
            const hostname = urlObj.hostname.toLowerCase();
            const path = urlObj.pathname;

            // TWITCH
            if (hostname.includes('twitch.tv')) {
                const parents = new Set(['localhost', '127.0.0.1']);
                if (currentHostname) parents.add(currentHostname);
                const parentString = Array.from(parents).map(p => `&parent=${p}`).join('');

                const pathParts = path.split('/').filter(p => p);
                if (pathParts.length > 0 && !path.includes('/videos/') && !path.includes('/clip/')) {
                    const channel = pathParts[0];
                    addChatOption(channel);
                    return {
                        html: `<iframe src="https://player.twitch.tv/?channel=${channel}${parentString}&muted=false" allowfullscreen></iframe>`,
                        type: 'twitch_live',
                        channel: channel
                    };
                }
                if (path.includes('/videos/')) {
                    const videoId = path.split('/videos/')[1].split('/')[0];
                    return { html: `<iframe src="https://player.twitch.tv/?video=${videoId}${parentString}&autoplay=false" allowfullscreen></iframe>` };
                }
                if (path.includes('/clip/')) {
                     return { html: `<iframe src="https://clips.twitch.tv/embed?clip=${path.split('/').pop()}${parentString}&autoplay=false" allowfullscreen></iframe>`};
                }
            }

            // YOUTUBE
            if (hostname.includes('youtube.com') || hostname.includes('youtu.be')) {
                let videoId = '';
                if (hostname.includes('youtu.be')) videoId = path.substring(1);
                else if (path.includes('/embed/')) videoId = path.split('/embed/')[1];
                else if (path.includes('/shorts/')) videoId = path.split('/shorts/')[1];
                else videoId = urlObj.searchParams.get('v');

                if (videoId) {
                    return { html: `<iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>` };
                }
            }

            // KICK
            if (hostname.includes('kick.com')) {
                const parts = path.split('/').filter(p => p);
                if (parts.length > 0) {
                    return { html: `<iframe src="https://player.kick.com/${parts[0]}" allowfullscreen></iframe>` };
                }
            }

            // GEN√âRICO (SANDBOX FIXED)
            return {
                html: `<iframe src="${url}" allowfullscreen sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-presentation"></iframe>`,
                type: 'generic'
            };

        } catch (e) {
            console.error(e);
            return null;
        }
    }

    function createCard(url, embedData) {
        const card = document.createElement('div');
        card.className = 'content-card';
        card.dataset.url = url;

        // Header Overlay
        const header = document.createElement('div');
        header.className = 'card-header-overlay';
        
        const leftGroup = document.createElement('div');
        leftGroup.className = 'btn-group';
        
        const aiInfoBtn = document.createElement('button');
        aiInfoBtn.className = 'btn-icon btn-ai-info';
        aiInfoBtn.innerHTML = '‚ú®'; 
        aiInfoBtn.title = 'Raio-X IA';
        
        const toastId = 'toast-' + Math.random().toString(36).substr(2, 9);
        const toast = document.createElement('div');
        toast.className = 'info-toast';
        toast.id = toastId;
        
        aiInfoBtn.onclick = () => handleAiInfo(url, toastId);
        leftGroup.appendChild(aiInfoBtn);

        const rightGroup = document.createElement('div');
        rightGroup.className = 'btn-group';

        const refreshBtn = document.createElement('button');
        refreshBtn.className = 'btn-icon';
        refreshBtn.innerHTML = '&#8635;';
        refreshBtn.title = 'Recarregar';
        refreshBtn.onclick = () => { const iframe = card.querySelector('iframe'); if(iframe) iframe.src = iframe.src; };

        const openBtn = document.createElement('button');
        openBtn.className = 'btn-icon';
        openBtn.innerHTML = '&#8599;'; 
        openBtn.title = 'Abrir no navegador';
        openBtn.onclick = () => window.open(url, '_blank');

        const closeBtn = document.createElement('button');
        closeBtn.className = 'btn-icon btn-remove';
        closeBtn.innerHTML = '&#10005;';
        closeBtn.title = 'Remover';
        closeBtn.onclick = () => {
            removeData(url);
            if(embedData.type === 'twitch_live') removeChatOption(embedData.channel);
            card.remove();
            resizeGrid(); // IMPORTANT: resize on remove
        };

        rightGroup.append(refreshBtn, openBtn, closeBtn);
        header.appendChild(leftGroup);
        header.appendChild(rightGroup);

        const wrapper = document.createElement('div');
        wrapper.className = 'iframe-wrapper';
        wrapper.innerHTML = embedData.html;

        card.appendChild(header);
        card.appendChild(toast);
        card.appendChild(wrapper);
        els.grid.appendChild(card);
        
        resizeGrid(); // IMPORTANT: resize on add
    }

    function addChatOption(channel) {
        if (!twitchChannels.includes(channel)) {
            twitchChannels.push(channel);
            renderChatOptions();
            if (twitchChannels.length === 1) {
                els.chatSelect.value = channel;
                changeChat();
            }
        }
    }

    function removeChatOption(channel) {
        twitchChannels = twitchChannels.filter(c => c !== channel);
        renderChatOptions();
        if (els.chatSelect.value === channel) {
            els.chatSelect.value = "";
            changeChat();
        }
    }

    function renderChatOptions() {
        const current = els.chatSelect.value;
        while (els.chatSelect.options.length > 1) els.chatSelect.remove(1);
        twitchChannels.forEach(ch => {
            const opt = document.createElement('option');
            opt.value = ch;
            opt.textContent = ch;
            els.chatSelect.appendChild(opt);
        });
        if (twitchChannels.includes(current)) els.chatSelect.value = current;
    }

    function resetChat() {
        els.chatSelect.value = "";
        changeChat();
    }

    function changeChat() {
        const channel = els.chatSelect.value;
        if (channel) {
            const parents = new Set(['localhost', '127.0.0.1']);
            if (currentHostname) parents.add(currentHostname);
            const parentString = Array.from(parents).map(p => `&parent=${p}`).join('');
            els.chatContainer.innerHTML = `<iframe src="https://www.twitch.tv/embed/${channel}/chat?darkpopout${parentString}" width="100%" height="100%" frameborder="0"></iframe>`;
        } else {
            els.chatContainer.innerHTML = `<div class="chat-placeholder"><p>Selecione um canal.</p></div>`;
        }
    }

    function saveData(url) {
        const data = JSON.parse(localStorage.getItem(LS_KEY)) || [];
        if (!data.includes(url)) {
            data.push(url);
            localStorage.setItem(LS_KEY, JSON.stringify(data));
        }
    }

    function removeData(url) {
        let data = JSON.parse(localStorage.getItem(LS_KEY)) || [];
        data = data.filter(u => u !== url);
        localStorage.setItem(LS_KEY, JSON.stringify(data));
    }

    function loadData() {
        const data = JSON.parse(localStorage.getItem(LS_KEY)) || [];
        data.forEach(url => {
            const embedData = generateEmbed(url);
            if (embedData) createCard(url, embedData);
        });
        resizeGrid(); // Ensure resizing on load
    }
  </script>
</body>
</html>
